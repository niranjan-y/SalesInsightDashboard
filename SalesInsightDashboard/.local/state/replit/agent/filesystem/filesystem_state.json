{"file_contents":{"README.md":{"content":"# Retail Sales Management & Analytics Dashboard\n\nA comprehensive retail sales management and analytics dashboard built with Streamlit, featuring real-time data visualization, CRUD operations, and export capabilities.\n\n## ðŸš€ Features\n\n### ðŸ“Š Dashboard & Analytics\n- **KPI Cards**: Total Sales, Monthly Revenue, Total Customers, Best-selling Product\n- **Interactive Charts**: Sales trends, top products, category breakdown, customer demographics\n- **Real-time Filters**: Date range, category, and customer filtering\n- **Responsive Design**: Wide layout optimized for desktop and tablet viewing\n\n### ðŸ“ Data Management\n- **Products Management**: Complete CRUD operations with low-stock alerts\n- **Customer Management**: Full customer lifecycle management\n- **Sales Management**: Transaction tracking with automatic stock updates\n- **Real-time Updates**: Immediate reflection of changes across all views\n\n### ðŸ“Š Reports & Export\n- **Multiple Report Types**: Sales, Products, and Customers reports\n- **Date Range Filtering**: Customizable reporting periods\n- **CSV Export**: Download filtered data for external analysis\n- **Summary Metrics**: Quick overview statistics for each report type\n\n### âš™ï¸ Settings & System\n- **Database Information**: Real-time statistics on data volumes\n- **System Actions**: Data refresh and maintenance functions\n- **About Information**: Application details and version information\n\n## ðŸ› ï¸ Technology Stack\n\n- **Frontend**: Streamlit with wide layout configuration\n- **Database**: SQLite with automated initialization\n- **Data Processing**: Pandas for data manipulation\n- **Visualizations**: Plotly Express for interactive charts\n- **Numerical Operations**: NumPy for calculations\n\n## ðŸ“ Project Structure\n\n","size_bytes":1749},"app.py":{"content":"import streamlit as st\nimport sqlite3\nimport pandas as pd\nimport plotly.express as px\nimport plotly.graph_objects as go\nimport numpy as np\nfrom datetime import datetime, date, timedelta\nimport io\nfrom typing import cast\nfrom sklearn.linear_model import LinearRegression\nfrom sklearn.preprocessing import PolynomialFeatures\nfrom sklearn.pipeline import Pipeline\nfrom sklearn.metrics import mean_absolute_error, r2_score\nimport scipy.stats as stats\nimport hashlib\nimport secrets\nimport uuid\nfrom functools import wraps\n\n# Configure page\nst.set_page_config(\n    page_title=\"Retail Sales Management & Analytics\",\n    page_icon=\"ðŸ›ï¸\",\n    layout=\"wide\",\n    initial_sidebar_state=\"expanded\"\n)\n\n# Database initialization\ndef init_db():\n    \"\"\"Initialize SQLite database with tables and demo data\"\"\"\n    conn = sqlite3.connect('database.db')\n    cursor = conn.cursor()\n    \n    # Create tables\n    cursor.execute('''\n        CREATE TABLE IF NOT EXISTS products (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            name TEXT NOT NULL,\n            category TEXT NOT NULL,\n            price REAL NOT NULL,\n            stock INTEGER NOT NULL,\n            description TEXT,\n            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n        )\n    ''')\n    \n    cursor.execute('''\n        CREATE TABLE IF NOT EXISTS customers (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            name TEXT NOT NULL,\n            email TEXT UNIQUE NOT NULL,\n            phone TEXT,\n            address TEXT,\n            gender TEXT CHECK(gender IN ('Male', 'Female', 'Other')),\n            age INTEGER,\n            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n        )\n    ''')\n    \n    cursor.execute('''\n        CREATE TABLE IF NOT EXISTS sales (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            product_id INTEGER NOT NULL,\n            customer_id INTEGER NOT NULL,\n            quantity INTEGER NOT NULL,\n            unit_price REAL NOT NULL,\n            total_amount REAL NOT NULL,\n            sale_date DATE NOT NULL,\n            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n            FOREIGN KEY (product_id) REFERENCES products (id),\n            FOREIGN KEY (customer_id) REFERENCES customers (id)\n        )\n    ''')\n    \n    # User management tables\n    cursor.execute('''\n        CREATE TABLE IF NOT EXISTS roles (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            name TEXT UNIQUE NOT NULL,\n            description TEXT,\n            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n        )\n    ''')\n    \n    cursor.execute('''\n        CREATE TABLE IF NOT EXISTS users (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            username TEXT UNIQUE NOT NULL,\n            email TEXT UNIQUE NOT NULL,\n            password_hash TEXT NOT NULL,\n            role_id INTEGER NOT NULL,\n            full_name TEXT,\n            is_active BOOLEAN DEFAULT 1,\n            last_login TIMESTAMP,\n            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n            FOREIGN KEY (role_id) REFERENCES roles (id)\n        )\n    ''')\n    \n    cursor.execute('''\n        CREATE TABLE IF NOT EXISTS permissions (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            name TEXT UNIQUE NOT NULL,\n            description TEXT,\n            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n        )\n    ''')\n    \n    cursor.execute('''\n        CREATE TABLE IF NOT EXISTS role_permissions (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            role_id INTEGER NOT NULL,\n            permission_id INTEGER NOT NULL,\n            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n            FOREIGN KEY (role_id) REFERENCES roles (id),\n            FOREIGN KEY (permission_id) REFERENCES permissions (id),\n            UNIQUE(role_id, permission_id)\n        )\n    ''')\n    \n    cursor.execute('''\n        CREATE TABLE IF NOT EXISTS user_sessions (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            user_id INTEGER NOT NULL,\n            session_token TEXT UNIQUE NOT NULL,\n            expires_at TIMESTAMP NOT NULL,\n            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n            FOREIGN KEY (user_id) REFERENCES users (id)\n        )\n    ''')\n    \n    # Initialize default roles and permissions\n    cursor.execute('SELECT COUNT(*) FROM roles')\n    if cursor.fetchone()[0] == 0:\n        # Default roles\n        roles = [\n            ('Super Admin', 'Full system access with all permissions'),\n            ('Manager', 'Management access with most features enabled'),\n            ('Sales Associate', 'Sales and customer management access'),\n            ('Viewer', 'Read-only access to reports and analytics')\n        ]\n        cursor.executemany('INSERT INTO roles (name, description) VALUES (?, ?)', roles)\n        \n        # Default permissions\n        permissions = [\n            ('view_dashboard', 'View main dashboard and analytics'),\n            ('manage_products', 'Create, edit, and delete products'),\n            ('manage_customers', 'Create, edit, and delete customers'),\n            ('manage_sales', 'Create, edit, and delete sales records'),\n            ('view_reports', 'Access to all reports and analytics'),\n            ('manage_users', 'Create, edit, and delete user accounts'),\n            ('manage_roles', 'Create and modify user roles and permissions'),\n            ('export_data', 'Export data in various formats'),\n            ('backup_restore', 'Backup and restore database'),\n            ('system_settings', 'Modify system-wide settings')\n        ]\n        cursor.executemany('INSERT INTO permissions (name, description) VALUES (?, ?)', permissions)\n        \n        # Role-Permission assignments\n        role_perms = [\n            # Super Admin - all permissions\n            (1, 1), (1, 2), (1, 3), (1, 4), (1, 5), (1, 6), (1, 7), (1, 8), (1, 9), (1, 10),\n            # Manager - most permissions except user/role management\n            (2, 1), (2, 2), (2, 3), (2, 4), (2, 5), (2, 8), (2, 9),\n            # Sales Associate - sales and customer focused\n            (3, 1), (3, 2), (3, 3), (3, 4), (3, 5), (3, 8),\n            # Viewer - read-only access\n            (4, 1), (4, 5)\n        ]\n        cursor.executemany('INSERT INTO role_permissions (role_id, permission_id) VALUES (?, ?)', role_perms)\n        \n        # Create default admin user (password: admin123) using secure hashing\n        admin_password_hash = hash_password('admin123')\n        cursor.execute('''\n            INSERT INTO users (username, email, password_hash, role_id, full_name)\n            VALUES (?, ?, ?, ?, ?)\n        ''', ('admin', 'admin@retail.com', admin_password_hash, 1, 'System Administrator'))\n    \n    # Check if demo data already exists\n    cursor.execute('SELECT COUNT(*) FROM products')\n    if cursor.fetchone()[0] == 0:\n        # Insert demo products\n        demo_products = [\n            ('Laptop Pro 15\"', 'Electronics', 1299.99, 25, 'High-performance laptop for professionals'),\n            ('Wireless Headphones', 'Electronics', 199.99, 50, 'Premium noise-cancelling headphones'),\n            ('Coffee Maker Deluxe', 'Appliances', 89.99, 30, 'Programmable coffee maker with thermal carafe'),\n            ('Running Shoes Elite', 'Sports', 129.99, 40, 'Professional running shoes with advanced cushioning'),\n            ('Desk Organizer Set', 'Office', 34.99, 75, 'Complete desk organization solution')\n        ]\n        cursor.executemany('INSERT INTO products (name, category, price, stock, description) VALUES (?, ?, ?, ?, ?)', demo_products)\n        \n        # Insert demo customers\n        demo_customers = [\n            ('John Smith', 'john.smith@email.com', '+1-555-0101', '123 Main St, City, State', 'Male', 32),\n            ('Sarah Johnson', 'sarah.j@email.com', '+1-555-0102', '456 Oak Ave, City, State', 'Female', 28),\n            ('Mike Davis', 'mike.davis@email.com', '+1-555-0103', '789 Pine Rd, City, State', 'Male', 45),\n            ('Emily Brown', 'emily.brown@email.com', '+1-555-0104', '321 Elm St, City, State', 'Female', 35),\n            ('Alex Chen', 'alex.chen@email.com', '+1-555-0105', '654 Maple Dr, City, State', 'Other', 29),\n            ('Lisa Wilson', 'lisa.wilson@email.com', '+1-555-0106', '987 Cedar Ln, City, State', 'Female', 41),\n            ('Tom Anderson', 'tom.anderson@email.com', '+1-555-0107', '147 Birch Way, City, State', 'Male', 38),\n            ('Kate Martinez', 'kate.martinez@email.com', '+1-555-0108', '258 Spruce Ave, City, State', 'Female', 33)\n        ]\n        cursor.executemany('INSERT INTO customers (name, email, phone, address, gender, age) VALUES (?, ?, ?, ?, ?, ?)', demo_customers)\n        \n        # Insert demo sales\n        demo_sales = [\n            (1, 1, 1, 1299.99, 1299.99, '2024-01-15'),\n            (2, 2, 2, 199.99, 399.98, '2024-01-16'),\n            (3, 3, 1, 89.99, 89.99, '2024-01-17'),\n            (4, 4, 1, 129.99, 129.99, '2024-01-18'),\n            (5, 5, 3, 34.99, 104.97, '2024-01-19'),\n            (1, 6, 1, 1299.99, 1299.99, '2024-01-20'),\n            (2, 7, 1, 199.99, 199.99, '2024-01-21'),\n            (3, 8, 2, 89.99, 179.98, '2024-01-22'),\n            (4, 1, 1, 129.99, 129.99, '2024-02-01'),\n            (5, 2, 2, 34.99, 69.98, '2024-02-02'),\n            (1, 3, 1, 1299.99, 1299.99, '2024-02-03'),\n            (2, 4, 3, 199.99, 599.97, '2024-02-04'),\n            (3, 5, 1, 89.99, 89.99, '2024-02-05'),\n            (4, 6, 2, 129.99, 259.98, '2024-02-06'),\n            (5, 7, 1, 34.99, 34.99, '2024-02-07'),\n            (1, 8, 1, 1299.99, 1299.99, '2024-02-08'),\n            (2, 1, 2, 199.99, 399.98, '2024-02-09'),\n            (3, 2, 1, 89.99, 89.99, '2024-02-10'),\n            (4, 3, 1, 129.99, 129.99, '2024-02-11'),\n            (5, 4, 4, 34.99, 139.96, '2024-02-12')\n        ]\n        cursor.executemany('INSERT INTO sales (product_id, customer_id, quantity, unit_price, total_amount, sale_date) VALUES (?, ?, ?, ?, ?, ?)', demo_sales)\n    \n    conn.commit()\n    conn.close()\n\n# Database helper functions\ndef get_connection():\n    \"\"\"Get database connection\"\"\"\n    return sqlite3.connect('database.db')\n\ndef get_products() -> pd.DataFrame:\n    \"\"\"Get all products from database\"\"\"\n    conn = get_connection()\n    df = pd.read_sql_query('SELECT * FROM products ORDER BY name', conn)\n    conn.close()\n    return df\n\ndef get_customers() -> pd.DataFrame:\n    \"\"\"Get all customers from database\"\"\"\n    conn = get_connection()\n    df = pd.read_sql_query('SELECT * FROM customers ORDER BY name', conn)\n    conn.close()\n    return df\n\ndef get_sales() -> pd.DataFrame:\n    \"\"\"Get all sales with product and customer details\"\"\"\n    conn = get_connection()\n    query = '''\n        SELECT s.id, s.product_id, s.customer_id, s.quantity, s.unit_price, s.total_amount, s.sale_date,\n               p.name as product_name, p.category, c.name as customer_name\n        FROM sales s\n        JOIN products p ON s.product_id = p.id\n        JOIN customers c ON s.customer_id = c.id\n        ORDER BY s.sale_date DESC\n    '''\n    df = pd.read_sql_query(query, conn)\n    conn.close()\n    return df\n\ndef add_product(name, category, price, stock, description):\n    \"\"\"Add new product to database\"\"\"\n    conn = get_connection()\n    cursor = conn.cursor()\n    cursor.execute(\n        'INSERT INTO products (name, category, price, stock, description) VALUES (?, ?, ?, ?, ?)',\n        (name, category, price, stock, description)\n    )\n    conn.commit()\n    conn.close()\n\ndef update_product(product_id, name, category, price, stock, description):\n    \"\"\"Update existing product\"\"\"\n    conn = get_connection()\n    cursor = conn.cursor()\n    cursor.execute(\n        'UPDATE products SET name=?, category=?, price=?, stock=?, description=? WHERE id=?',\n        (name, category, price, stock, description, product_id)\n    )\n    conn.commit()\n    conn.close()\n\ndef delete_product(product_id):\n    \"\"\"Delete product from database\"\"\"\n    conn = get_connection()\n    cursor = conn.cursor()\n    cursor.execute('DELETE FROM products WHERE id=?', (product_id,))\n    conn.commit()\n    conn.close()\n\ndef add_customer(name, email, phone, address, gender, age):\n    \"\"\"Add new customer to database\"\"\"\n    conn = get_connection()\n    cursor = conn.cursor()\n    cursor.execute(\n        'INSERT INTO customers (name, email, phone, address, gender, age) VALUES (?, ?, ?, ?, ?, ?)',\n        (name, email, phone, address, gender, age)\n    )\n    conn.commit()\n    conn.close()\n\ndef update_customer(customer_id, name, email, phone, address, gender, age):\n    \"\"\"Update existing customer\"\"\"\n    conn = get_connection()\n    cursor = conn.cursor()\n    cursor.execute(\n        'UPDATE customers SET name=?, email=?, phone=?, address=?, gender=?, age=? WHERE id=?',\n        (name, email, phone, address, gender, age, customer_id)\n    )\n    conn.commit()\n    conn.close()\n\ndef delete_customer(customer_id):\n    \"\"\"Delete customer from database\"\"\"\n    conn = get_connection()\n    cursor = conn.cursor()\n    cursor.execute('DELETE FROM customers WHERE id=?', (customer_id,))\n    conn.commit()\n    conn.close()\n\ndef add_sale(product_id, customer_id, quantity, sale_date):\n    \"\"\"Add new sale to database\"\"\"\n    conn = get_connection()\n    cursor = conn.cursor()\n    \n    # Get product price\n    cursor.execute('SELECT price, stock FROM products WHERE id=?', (product_id,))\n    result = cursor.fetchone()\n    if not result:\n        conn.close()\n        return False, \"Product not found\"\n    \n    price, current_stock = result\n    if current_stock < quantity:\n        conn.close()\n        return False, f\"Insufficient stock. Available: {current_stock}\"\n    \n    total_amount = price * quantity\n    \n    # Insert sale\n    cursor.execute(\n        'INSERT INTO sales (product_id, customer_id, quantity, unit_price, total_amount, sale_date) VALUES (?, ?, ?, ?, ?, ?)',\n        (product_id, customer_id, quantity, price, total_amount, sale_date)\n    )\n    \n    # Update product stock\n    cursor.execute('UPDATE products SET stock = stock - ? WHERE id=?', (quantity, product_id))\n    \n    conn.commit()\n    conn.close()\n    return True, \"Sale added successfully\"\n\ndef delete_sale(sale_id):\n    \"\"\"Delete sale and restore product stock\"\"\"\n    conn = get_connection()\n    cursor = conn.cursor()\n    \n    # Get sale details first\n    cursor.execute('SELECT product_id, quantity FROM sales WHERE id=?', (sale_id,))\n    result = cursor.fetchone()\n    if result:\n        product_id, quantity = result\n        # Restore stock\n        cursor.execute('UPDATE products SET stock = stock + ? WHERE id=?', (quantity, product_id))\n        # Delete sale\n        cursor.execute('DELETE FROM sales WHERE id=?', (sale_id,))\n    \n    conn.commit()\n    conn.close()\n\ndef get_kpis():\n    \"\"\"Calculate KPIs from database\"\"\"\n    conn = get_connection()\n    \n    # Total sales\n    cursor = conn.cursor()\n    cursor.execute('SELECT SUM(total_amount) FROM sales')\n    total_sales = cursor.fetchone()[0] or 0\n    \n    # Monthly revenue (current month)\n    current_month = datetime.now().strftime('%Y-%m')\n    cursor.execute('SELECT SUM(total_amount) FROM sales WHERE sale_date LIKE ?', (f'{current_month}%',))\n    monthly_revenue = cursor.fetchone()[0] or 0\n    \n    # Total customers\n    cursor.execute('SELECT COUNT(*) FROM customers')\n    total_customers = cursor.fetchone()[0] or 0\n    \n    # Best-selling product\n    cursor.execute('''\n        SELECT p.name, SUM(s.quantity) as total_qty\n        FROM sales s\n        JOIN products p ON s.product_id = p.id\n        GROUP BY s.product_id, p.name\n        ORDER BY total_qty DESC\n        LIMIT 1\n    ''')\n    result = cursor.fetchone()\n    best_product = result[0] if result else \"No sales yet\"\n    \n    conn.close()\n    \n    return {\n        'total_sales': total_sales,\n        'monthly_revenue': monthly_revenue,\n        'total_customers': total_customers,\n        'best_product': best_product\n    }\n\n# === AUTHENTICATION AND SESSION MANAGEMENT ===\n\ndef hash_password(password: str) -> str:\n    \"\"\"Hash password using PBKDF2-HMAC-SHA256 for enterprise-grade security\"\"\"\n    # Generate a cryptographically secure salt\n    salt = secrets.token_bytes(32)  # 32 bytes = 256 bits\n    \n    # Use PBKDF2-HMAC-SHA256 with 100,000 iterations (recommended minimum)\n    password_hash = hashlib.pbkdf2_hmac(\n        'sha256',\n        password.encode('utf-8'),\n        salt,\n        100000  # 100,000 iterations for computational resistance\n    )\n    \n    # Return base64-encoded salt + hash for storage\n    import base64\n    salt_b64 = base64.b64encode(salt).decode('ascii')\n    hash_b64 = base64.b64encode(password_hash).decode('ascii')\n    return f\"pbkdf2${salt_b64}${hash_b64}\"\n\ndef verify_password(password: str, stored_hash: str) -> bool:\n    \"\"\"Verify password with constant-time comparison and legacy support\"\"\"\n    import base64\n    import hmac\n    \n    # Check format to determine hash type\n    if stored_hash.startswith('pbkdf2$'):\n        # New PBKDF2 format: pbkdf2$salt_b64$hash_b64\n        try:\n            parts = stored_hash.split('$')\n            if len(parts) != 3:\n                return False\n            \n            salt = base64.b64decode(parts[1])\n            expected_hash = base64.b64decode(parts[2])\n            \n            # Hash the provided password with stored salt\n            computed_hash = hashlib.pbkdf2_hmac(\n                'sha256',\n                password.encode('utf-8'),\n                salt,\n                100000\n            )\n            \n            # Use constant-time comparison to prevent timing attacks\n            return hmac.compare_digest(expected_hash, computed_hash)\n        except Exception:\n            return False\n    \n    elif len(stored_hash) == 64:\n        # Legacy unsalted SHA-256 verification\n        legacy_hash = hashlib.sha256(password.encode()).hexdigest()\n        return hmac.compare_digest(legacy_hash, stored_hash)\n    \n    elif len(stored_hash) == 96:\n        # Legacy salted SHA-256 verification\n        try:\n            salt = stored_hash[:32]\n            expected_hash = stored_hash[32:]\n            \n            salted_password = salt + password\n            password_hash = hashlib.sha256(salted_password.encode()).hexdigest()\n            \n            return hmac.compare_digest(password_hash, expected_hash)\n        except Exception:\n            return False\n    \n    return False\n\ndef migrate_legacy_password(user_id: int, password: str):\n    \"\"\"Migrate legacy password to new PBKDF2 format\"\"\"\n    conn = get_connection()\n    cursor = conn.cursor()\n    \n    # Create new PBKDF2 hash\n    new_hash = hash_password(password)\n    \n    # Update the user's password hash\n    cursor.execute('UPDATE users SET password_hash = ? WHERE id = ?', (new_hash, user_id))\n    conn.commit()\n    conn.close()\n\ndef create_session_token() -> str:\n    \"\"\"Generate a secure session token\"\"\"\n    return secrets.token_urlsafe(32)\n\ndef create_user_session(user_id: int) -> str:\n    \"\"\"Create a new session for user\"\"\"\n    conn = get_connection()\n    cursor = conn.cursor()\n    \n    # Clean up expired sessions\n    cursor.execute('DELETE FROM user_sessions WHERE expires_at < ?', (datetime.now(),))\n    \n    # Create new session\n    session_token = create_session_token()\n    expires_at = datetime.now() + timedelta(hours=24)  # 24 hour sessions\n    \n    cursor.execute('''\n        INSERT INTO user_sessions (user_id, session_token, expires_at)\n        VALUES (?, ?, ?)\n    ''', (user_id, session_token, expires_at))\n    \n    conn.commit()\n    conn.close()\n    return session_token\n\ndef get_user_from_session(session_token: str):\n    \"\"\"Get user from session token\"\"\"\n    if not session_token:\n        return None\n    \n    conn = get_connection()\n    cursor = conn.cursor()\n    \n    # Get user from valid session\n    cursor.execute('''\n        SELECT u.id, u.username, u.email, u.full_name, u.role_id, r.name as role_name\n        FROM users u\n        JOIN user_sessions s ON u.id = s.user_id\n        JOIN roles r ON u.role_id = r.id\n        WHERE s.session_token = ? AND s.expires_at > ? AND u.is_active = 1\n    ''', (session_token, datetime.now()))\n    \n    result = cursor.fetchone()\n    conn.close()\n    \n    if result:\n        return {\n            'id': result[0],\n            'username': result[1],\n            'email': result[2],\n            'full_name': result[3],\n            'role_id': result[4],\n            'role_name': result[5]\n        }\n    return None\n\ndef authenticate_user(username: str, password: str):\n    \"\"\"Authenticate user with username and password and migrate legacy passwords\"\"\"\n    conn = get_connection()\n    cursor = conn.cursor()\n    \n    cursor.execute('''\n        SELECT id, username, email, password_hash, full_name, role_id, is_active\n        FROM users\n        WHERE username = ? OR email = ?\n    ''', (username, username))\n    \n    result = cursor.fetchone()\n    \n    if result and result[6] and verify_password(password, result[3]):\n        user_id = result[0]\n        password_hash = result[3]\n        \n        # Check if this is any legacy password format and migrate to PBKDF2\n        if not password_hash.startswith('pbkdf2$'):\n            # Migrate any legacy format (unsalted SHA-256 or salted SHA-256) to PBKDF2\n            migrate_legacy_password(user_id, password)\n        \n        # Update last login\n        cursor.execute('UPDATE users SET last_login = ? WHERE id = ?', (datetime.now(), user_id))\n        conn.commit()\n        conn.close()\n        \n        return {\n            'id': user_id,\n            'username': result[1],\n            'email': result[2],\n            'full_name': result[4],\n            'role_id': result[5]\n        }\n    \n    conn.close()\n    return None\n\ndef logout_user(session_token: str):\n    \"\"\"Logout user by removing session\"\"\"\n    conn = get_connection()\n    cursor = conn.cursor()\n    cursor.execute('DELETE FROM user_sessions WHERE session_token = ?', (session_token,))\n    conn.commit()\n    conn.close()\n\ndef get_user_permissions(user_id: int) -> list:\n    \"\"\"Get user permissions based on role\"\"\"\n    conn = get_connection()\n    cursor = conn.cursor()\n    \n    cursor.execute('''\n        SELECT p.name\n        FROM permissions p\n        JOIN role_permissions rp ON p.id = rp.permission_id\n        JOIN users u ON rp.role_id = u.role_id\n        WHERE u.id = ?\n    ''', (user_id,))\n    \n    permissions = [row[0] for row in cursor.fetchall()]\n    conn.close()\n    return permissions\n\ndef has_permission(user_id: int, permission: str) -> bool:\n    \"\"\"Check if user has specific permission\"\"\"\n    permissions = get_user_permissions(user_id)\n    return permission in permissions\n\ndef require_permission(permission: str):\n    \"\"\"Decorator to require specific permission\"\"\"\n    def decorator(func):\n        @wraps(func)\n        def wrapper(*args, **kwargs):\n            if 'current_user' not in st.session_state or not st.session_state.current_user:\n                st.error(\"Authentication required\")\n                return None\n            \n            user_id = st.session_state.current_user['id']\n            if not has_permission(user_id, permission):\n                st.error(\"You don't have permission to access this feature\")\n                return None\n            \n            return func(*args, **kwargs)\n        return wrapper\n    return decorator\n\ndef get_all_users():\n    \"\"\"Get all users with role information\"\"\"\n    conn = get_connection()\n    query = '''\n        SELECT u.id, u.username, u.email, u.full_name, u.is_active, u.last_login, r.name as role_name\n        FROM users u\n        JOIN roles r ON u.role_id = r.id\n        ORDER BY u.username\n    '''\n    df = pd.read_sql_query(query, conn)\n    conn.close()\n    return df\n\ndef get_all_roles():\n    \"\"\"Get all roles\"\"\"\n    conn = get_connection()\n    df = pd.read_sql_query('SELECT * FROM roles ORDER BY name', conn)\n    conn.close()\n    return df\n\ndef create_user(username: str, email: str, password: str, role_id: int, full_name: str = None, current_user_id: int = None):\n    \"\"\"Create new user with permission validation\"\"\"\n    # Server-side permission check\n    if current_user_id:\n        if not has_permission(current_user_id, 'manage_users'):\n            return False, \"Insufficient permissions to create users\"\n    \n    conn = get_connection()\n    cursor = conn.cursor()\n    \n    try:\n        password_hash = hash_password(password)\n        cursor.execute('''\n            INSERT INTO users (username, email, password_hash, role_id, full_name)\n            VALUES (?, ?, ?, ?, ?)\n        ''', (username, email, password_hash, role_id, full_name))\n        conn.commit()\n        conn.close()\n        return True, \"User created successfully\"\n    except sqlite3.IntegrityError as e:\n        conn.close()\n        if 'username' in str(e):\n            return False, \"Username already exists\"\n        elif 'email' in str(e):\n            return False, \"Email already exists\"\n        else:\n            return False, \"Error creating user\"\n\ndef update_user(user_id: int, username: str, email: str, role_id: int, full_name: str, is_active: bool, current_user_id: int = None):\n    \"\"\"Update existing user with security checks\"\"\"\n    # Server-side permission check\n    if current_user_id:\n        if not has_permission(current_user_id, 'manage_users'):\n            return False, \"Insufficient permissions to update users\"\n        \n        # Prevent updating your own role or deactivating yourself\n        if user_id == current_user_id:\n            return False, \"You cannot modify your own account through this interface\"\n    \n    conn = get_connection()\n    cursor = conn.cursor()\n    \n    # Check if target user is Super Admin and prevent role changes\n    cursor.execute('''\n        SELECT r.name FROM users u \n        JOIN roles r ON u.role_id = r.id \n        WHERE u.id = ?\n    ''', (user_id,))\n    result = cursor.fetchone()\n    \n    if result and result[0] == 'Super Admin':\n        # Don't allow changing Super Admin role or status\n        cursor.execute('SELECT role_id FROM roles WHERE name = ?', ('Super Admin',))\n        super_admin_role_id = cursor.fetchone()[0]\n        if role_id != super_admin_role_id or not is_active:\n            conn.close()\n            return False, \"Cannot modify Super Admin accounts\"\n    \n    try:\n        cursor.execute('''\n            UPDATE users SET username=?, email=?, role_id=?, full_name=?, is_active=?\n            WHERE id=?\n        ''', (username, email, role_id, full_name, is_active, user_id))\n        conn.commit()\n        conn.close()\n        return True, \"User updated successfully\"\n    except sqlite3.IntegrityError as e:\n        conn.close()\n        if 'username' in str(e):\n            return False, \"Username already exists\"\n        elif 'email' in str(e):\n            return False, \"Email already exists\"\n        else:\n            return False, \"Error updating user\"\n\ndef delete_user(user_id: int, current_user_id: int):\n    \"\"\"Delete user with proper security checks\"\"\"\n    # Security checks\n    if user_id == current_user_id:\n        return False, \"You cannot delete your own account\"\n    \n    conn = get_connection()\n    cursor = conn.cursor()\n    \n    # Check if target user is a Super Admin\n    cursor.execute('''\n        SELECT r.name FROM users u \n        JOIN roles r ON u.role_id = r.id \n        WHERE u.id = ?\n    ''', (user_id,))\n    result = cursor.fetchone()\n    \n    if not result:\n        conn.close()\n        return False, \"User not found\"\n    \n    if result[0] == 'Super Admin':\n        conn.close()\n        return False, \"Cannot delete Super Admin accounts\"\n    \n    # Check if this is the last Super Admin (prevent system lockout)\n    cursor.execute('''\n        SELECT COUNT(*) FROM users u \n        JOIN roles r ON u.role_id = r.id \n        WHERE r.name = 'Super Admin' AND u.is_active = 1\n    ''')\n    admin_count = cursor.fetchone()[0]\n    \n    if admin_count <= 1:\n        conn.close()\n        return False, \"Cannot delete the last Super Admin account\"\n    \n    try:\n        # Delete user sessions first\n        cursor.execute('DELETE FROM user_sessions WHERE user_id=?', (user_id,))\n        # Delete user\n        cursor.execute('DELETE FROM users WHERE id=?', (user_id,))\n        \n        conn.commit()\n        conn.close()\n        return True, \"User deleted successfully\"\n    except Exception as e:\n        conn.close()\n        return False, f\"Error deleting user: {str(e)}\"\n\n# Session management for Streamlit\ndef check_authentication():\n    \"\"\"Check if user is authenticated via session state\"\"\"\n    if 'session_token' in st.session_state:\n        user = get_user_from_session(st.session_state.session_token)\n        if user:\n            st.session_state.current_user = user\n            return True\n    \n    # Clear invalid session\n    if 'session_token' in st.session_state:\n        del st.session_state.session_token\n    if 'current_user' in st.session_state:\n        del st.session_state.current_user\n    \n    return False\n\ndef login_form():\n    \"\"\"Display login form\"\"\"\n    st.markdown(\"### ðŸ” Login to Retail Dashboard\")\n    \n    with st.form(\"login_form\"):\n        username = st.text_input(\"Username or Email\")\n        password = st.text_input(\"Password\", type=\"password\")\n        submit = st.form_submit_button(\"Login\")\n        \n        if submit:\n            if username and password:\n                user = authenticate_user(username, password)\n                if user:\n                    session_token = create_user_session(user['id'])\n                    st.session_state.session_token = session_token\n                    st.session_state.current_user = user\n                    st.success(\"Login successful!\")\n                    st.rerun()\n                else:\n                    st.error(\"Invalid username/email or password\")\n            else:\n                st.error(\"Please enter both username and password\")\n    \n    st.info(\"Default login: **admin** / **admin123**\")\n\n# === FORECASTING FUNCTIONS ===\n\ndef prepare_sales_data_for_forecasting():\n    \"\"\"Prepare historical sales data for forecasting\"\"\"\n    sales_df = get_sales()\n    if len(sales_df) == 0:\n        return None\n    \n    # Convert to datetime and aggregate by date\n    sales_df['sale_date'] = pd.to_datetime(sales_df['sale_date'])\n    daily_sales = sales_df.groupby('sale_date')['total_amount'].sum().reset_index()\n    daily_sales = daily_sales.sort_values('sale_date')\n    \n    # Create numerical features for modeling\n    daily_sales['days_since_start'] = (daily_sales['sale_date'] - daily_sales['sale_date'].min()).dt.days\n    \n    return daily_sales\n\ndef generate_sales_forecast(days_ahead=30, model_type='linear', confidence_level=90):\n    \"\"\"Generate sales forecast using machine learning models with confidence intervals\"\"\"\n    daily_sales = prepare_sales_data_for_forecasting()\n    \n    if daily_sales is None or len(daily_sales) < 7:\n        return None, None, None\n    \n    X = daily_sales[['days_since_start']].values\n    y = daily_sales['total_amount'].values\n    \n    # Choose model based on type\n    if model_type == 'polynomial':\n        model = Pipeline([\n            ('poly', PolynomialFeatures(degree=2)),\n            ('linear', LinearRegression())\n        ])\n    else:\n        model = LinearRegression()\n    \n    # Fit the model\n    model.fit(X, y)\n    \n    # Calculate model performance and residuals\n    y_pred = model.predict(X)\n    mae = mean_absolute_error(y, y_pred)\n    r2 = r2_score(y, y_pred)\n    residuals = y - y_pred\n    residual_std = np.std(residuals)\n    \n    # Generate future predictions with confidence intervals\n    last_day = daily_sales['days_since_start'].max()\n    future_days = np.arange(last_day + 1, last_day + days_ahead + 1).reshape(-1, 1)\n    future_predictions = model.predict(future_days)\n    \n    # Calculate confidence intervals\n    alpha = (100 - confidence_level) / 100\n    t_critical = stats.t.ppf(1 - alpha/2, len(y) - 2)  # degrees of freedom = n - 2\n    margin_error = t_critical * residual_std\n    \n    # Create forecast dataframe with confidence intervals\n    start_date = daily_sales['sale_date'].max() + timedelta(days=1)\n    future_dates = [start_date + timedelta(days=i) for i in range(days_ahead)]\n    \n    forecast_df = pd.DataFrame({\n        'date': future_dates,\n        'predicted_sales': np.maximum(future_predictions, 0),  # Ensure non-negative predictions\n        'lower_bound': np.maximum(future_predictions - margin_error, 0),\n        'upper_bound': future_predictions + margin_error\n    })\n    \n    return daily_sales, forecast_df, {'mae': mae, 'r2': r2, 'model_type': model_type, 'confidence_level': confidence_level}\n\ndef get_product_sales_velocity(analysis_days=60):\n    \"\"\"Calculate sales velocity for inventory management\"\"\"\n    sales_df = get_sales()\n    if len(sales_df) == 0:\n        return pd.DataFrame(), []\n    \n    # Convert to datetime and get date range\n    sales_df['sale_date'] = pd.to_datetime(sales_df['sale_date'])\n    \n    # Use configurable analysis window, fallback to available data if needed\n    max_date = sales_df['sale_date'].max()\n    min_date = sales_df['sale_date'].min()\n    analysis_start = max_date - timedelta(days=analysis_days)\n    \n    # If analysis period extends before available data, use all available data\n    if analysis_start < min_date:\n        analysis_start = min_date\n        actual_days = (max_date - min_date).days + 1\n    else:\n        actual_days = analysis_days\n    \n    recent_sales = sales_df[sales_df['sale_date'] >= analysis_start]\n    \n    # Group by product and calculate metrics\n    product_velocity = recent_sales.groupby(['product_id', 'product_name']).agg({\n        'quantity': 'sum',\n        'total_amount': 'sum',\n        'sale_date': 'count'\n    }).reset_index()\n    \n    product_velocity['avg_daily_quantity'] = product_velocity['quantity'] / actual_days\n    product_velocity['avg_daily_revenue'] = product_velocity['total_amount'] / actual_days\n    product_velocity.rename(columns={'sale_date': 'transaction_count'}, inplace=True)\n    \n    # Get current stock levels\n    products_df = get_products()\n    product_velocity = product_velocity.merge(\n        products_df[['id', 'stock']], \n        left_on='product_id', \n        right_on='id', \n        how='left'\n    )\n    \n    # Calculate days until stockout\n    product_velocity['days_until_stockout'] = np.where(\n        product_velocity['avg_daily_quantity'] > 0,\n        product_velocity['stock'] / product_velocity['avg_daily_quantity'],\n        float('inf')\n    )\n    \n    # Generate concrete reorder recommendations\n    recommendations = []\n    \n    # Urgent reorders (< 7 days)\n    urgent = product_velocity[product_velocity['days_until_stockout'] < 7]\n    for _, product in urgent.iterrows():\n        if product['days_until_stockout'] != float('inf'):\n            recommendations.append({\n                'type': 'urgent',\n                'product_name': product['product_name'],\n                'current_stock': int(product['stock']),\n                'days_until_stockout': product['days_until_stockout'],\n                'avg_daily_sales': product['avg_daily_quantity'],\n                'recommended_order': max(int(product['avg_daily_quantity'] * 30), 10),  # 30-day supply minimum\n                'message': f\"URGENT: {product['product_name']} will run out in {product['days_until_stockout']:.1f} days\"\n            })\n    \n    # Warning reorders (7-14 days)\n    warning = product_velocity[\n        (product_velocity['days_until_stockout'] >= 7) & \n        (product_velocity['days_until_stockout'] < 14)\n    ]\n    for _, product in warning.iterrows():\n        recommendations.append({\n            'type': 'warning',\n            'product_name': product['product_name'],\n            'current_stock': int(product['stock']),\n            'days_until_stockout': product['days_until_stockout'],\n            'avg_daily_sales': product['avg_daily_quantity'],\n            'recommended_order': max(int(product['avg_daily_quantity'] * 21), 5),  # 21-day supply\n            'message': f\"WARNING: {product['product_name']} needs reordering soon ({product['days_until_stockout']:.1f} days left)\"\n        })\n    \n    # Low performers (no recent sales but have stock)\n    no_sales = product_velocity[product_velocity['avg_daily_quantity'] == 0]\n    for _, product in no_sales.iterrows():\n        if product['stock'] > 0:\n            recommendations.append({\n                'type': 'slow_mover',\n                'product_name': product['product_name'],\n                'current_stock': int(product['stock']),\n                'days_until_stockout': float('inf'),\n                'avg_daily_sales': 0,\n                'recommended_order': 0,\n                'message': f\"SLOW MOVER: {product['product_name']} has no sales in last {actual_days} days\"\n            })\n    \n    return product_velocity.sort_values('days_until_stockout'), recommendations\n\n# === CUSTOMER SEGMENTATION FUNCTIONS ===\n\ndef calculate_rfm_metrics():\n    \"\"\"Calculate RFM (Recency, Frequency, Monetary) metrics for customer segmentation\"\"\"\n    sales_df = get_sales()\n    customers_df = get_customers()\n    \n    if len(sales_df) == 0 or len(customers_df) == 0:\n        return pd.DataFrame()\n    \n    # Convert sale_date to datetime\n    sales_df['sale_date'] = pd.to_datetime(sales_df['sale_date'])\n    \n    # Calculate the analysis date (most recent sale date + 1 day)\n    analysis_date = sales_df['sale_date'].max() + timedelta(days=1)\n    \n    # Calculate RFM metrics for each customer\n    rfm_metrics = sales_df.groupby('customer_id').agg({\n        'sale_date': lambda x: (analysis_date - x.max()).days,  # Recency (days since last purchase)\n        'id': 'count',  # Frequency (number of transactions)\n        'total_amount': 'sum'  # Monetary (total spending)\n    }).reset_index()\n    \n    rfm_metrics.columns = ['customer_id', 'recency', 'frequency', 'monetary']\n    \n    # Merge with customer details\n    rfm_data = rfm_metrics.merge(\n        customers_df[['id', 'name', 'email', 'age', 'gender']], \n        left_on='customer_id', \n        right_on='id', \n        how='left'\n    )\n    \n    # Calculate RFM scores (1-5 scale, 5 being the best)\n    # Handle small datasets gracefully\n    num_customers = len(rfm_data)\n    \n    if num_customers < 5:\n        # For small datasets, use simple scoring based on relative position\n        # Recency: Lower days is better (recent purchases get higher scores)\n        rfm_data['r_score'] = rfm_data['recency'].rank(method='min', ascending=True).apply(\n            lambda x: min(5, max(1, int(6 - ((x - 1) / max(1, num_customers - 1)) * 4)))\n        )\n        \n        # Frequency: Higher is better (more purchases)\n        rfm_data['f_score'] = rfm_data['frequency'].rank(method='min', ascending=True).apply(\n            lambda x: min(5, max(1, int(1 + ((x - 1) / max(1, num_customers - 1)) * 4)))\n        )\n        \n        # Monetary: Higher is better (more spending)\n        rfm_data['m_score'] = rfm_data['monetary'].rank(method='min', ascending=True).apply(\n            lambda x: min(5, max(1, int(1 + ((x - 1) / max(1, num_customers - 1)) * 4)))\n        )\n    else:\n        # For larger datasets, use quintile binning with duplicate handling\n        try:\n            # Recency: Lower is better (recent purchases)\n            rfm_data['r_score'] = pd.qcut(rfm_data['recency'].rank(method='first'), 5, labels=[5,4,3,2,1], duplicates='drop')\n            \n            # Frequency: Higher is better (more purchases)\n            rfm_data['f_score'] = pd.qcut(rfm_data['frequency'].rank(method='first'), 5, labels=[1,2,3,4,5], duplicates='drop')\n            \n            # Monetary: Higher is better (more spending)\n            rfm_data['m_score'] = pd.qcut(rfm_data['monetary'].rank(method='first'), 5, labels=[1,2,3,4,5], duplicates='drop')\n        except ValueError:\n            # Fallback to rank-based scoring if qcut still fails\n            rfm_data['r_score'] = rfm_data['recency'].rank(method='min', ascending=True, pct=True).apply(\n                lambda x: min(5, max(1, int(6 - x * 5)))\n            )\n            rfm_data['f_score'] = rfm_data['frequency'].rank(method='min', ascending=True, pct=True).apply(\n                lambda x: min(5, max(1, int(1 + x * 4)))\n            )\n            rfm_data['m_score'] = rfm_data['monetary'].rank(method='min', ascending=True, pct=True).apply(\n                lambda x: min(5, max(1, int(1 + x * 4)))\n            )\n    \n    # Ensure scores are integers\n    rfm_data['r_score'] = rfm_data['r_score'].astype(int)\n    rfm_data['f_score'] = rfm_data['f_score'].astype(int)\n    rfm_data['m_score'] = rfm_data['m_score'].astype(int)\n    \n    # Create combined RFM score\n    rfm_data['rfm_score'] = rfm_data['r_score'].astype(str) + rfm_data['f_score'].astype(str) + rfm_data['m_score'].astype(str)\n    \n    return rfm_data\n\ndef segment_customers(rfm_data):\n    \"\"\"Segment customers based on RFM scores\"\"\"\n    if len(rfm_data) == 0:\n        return pd.DataFrame(), pd.DataFrame(), {}\n    \n    # Define customer segments based on RFM scores\n    def get_segment(row):\n        r, f, m = int(row['r_score']), int(row['f_score']), int(row['m_score'])\n        \n        # Champions: Best customers (high on all metrics)\n        if r >= 4 and f >= 4 and m >= 4:\n            return 'Champions'\n        \n        # Loyal Customers: High frequency and monetary, decent recency\n        elif r >= 3 and f >= 4 and m >= 3:\n            return 'Loyal Customers'\n        \n        # Potential Loyalists: Recent customers with good potential\n        elif r >= 4 and f >= 2 and m >= 2:\n            return 'Potential Loyalists'\n        \n        # New Customers: Very recent but low frequency/monetary\n        elif r >= 4 and f <= 2 and m <= 2:\n            return 'New Customers'\n        \n        # Promising: Recent with decent frequency or monetary\n        elif r >= 3 and f >= 2 and m >= 2:\n            return 'Promising'\n        \n        # Need Attention: Above average on frequency and monetary but not recent\n        elif r <= 3 and f >= 3 and m >= 3:\n            return 'Need Attention'\n        \n        # About to Sleep: Below average recency and frequency\n        elif r <= 3 and f <= 3 and m >= 2:\n            return 'About to Sleep'\n        \n        # At Risk: Low recency but previously good customers\n        elif r <= 2 and f >= 3 and m >= 3:\n            return 'At Risk'\n        \n        # Cannot Lose Them: Very low recency but high monetary\n        elif r <= 2 and f <= 3 and m >= 4:\n            return 'Cannot Lose Them'\n        \n        # Hibernating: Low on all metrics but some past value\n        elif r <= 2 and f <= 2 and m >= 2:\n            return 'Hibernating'\n        \n        # Lost: Very low on recency and frequency\n        else:\n            return 'Lost'\n    \n    # Apply segmentation\n    rfm_data['segment'] = rfm_data.apply(get_segment, axis=1)\n    \n    # Calculate segment statistics\n    segment_stats = rfm_data.groupby('segment').agg({\n        'customer_id': 'count',\n        'recency': 'mean',\n        'frequency': 'mean',\n        'monetary': ['mean', 'sum'],\n        'age': 'mean'\n    }).round(2)\n    \n    segment_stats.columns = ['count', 'avg_recency', 'avg_frequency', 'avg_monetary', 'total_revenue', 'avg_age']\n    segment_stats = segment_stats.reset_index()\n    \n    # Calculate percentage of total customers\n    total_customers = len(rfm_data)\n    segment_stats['percentage'] = (segment_stats['count'] / total_customers * 100).round(1)\n    \n    # Define marketing recommendations for each segment\n    marketing_recommendations = {\n        'Champions': {\n            'strategy': 'Reward and Retain',\n            'actions': ['VIP treatment', 'Early access to new products', 'Loyalty rewards'],\n            'message': 'Your best customers! Focus on retention and advocacy.'\n        },\n        'Loyal Customers': {\n            'strategy': 'Upsell and Cross-sell',\n            'actions': ['Product recommendations', 'Premium offerings', 'Exclusive deals'],\n            'message': 'Reliable customers who respond well to upselling.'\n        },\n        'Potential Loyalists': {\n            'strategy': 'Develop Loyalty',\n            'actions': ['Membership programs', 'Product education', 'Engagement campaigns'],\n            'message': 'Recent customers with potential for loyalty development.'\n        },\n        'New Customers': {\n            'strategy': 'Onboard and Educate',\n            'actions': ['Welcome campaigns', 'Product tutorials', 'Support offers'],\n            'message': 'New customers who need guidance and support.'\n        },\n        'Promising': {\n            'strategy': 'Nurture and Grow',\n            'actions': ['Targeted offers', 'Product bundles', 'Engagement content'],\n            'message': 'Good potential customers who need nurturing.'\n        },\n        'Need Attention': {\n            'strategy': 'Re-engage',\n            'actions': ['Personalized offers', 'Satisfaction surveys', 'Win-back campaigns'],\n            'message': 'Previously good customers who are becoming less active.'\n        },\n        'About to Sleep': {\n            'strategy': 'Reactivate',\n            'actions': ['Limited-time offers', 'Reactivation emails', 'Incentives'],\n            'message': 'Customers at risk of becoming inactive.'\n        },\n        'At Risk': {\n            'strategy': 'Win Back',\n            'actions': ['Aggressive discounts', 'Personal outreach', 'Feedback requests'],\n            'message': 'Important customers who are at risk of churning.'\n        },\n        'Cannot Lose Them': {\n            'strategy': 'Urgent Recovery',\n            'actions': ['Personal calls', 'Exclusive offers', 'Account management'],\n            'message': 'High-value customers who must be retained immediately.'\n        },\n        'Hibernating': {\n            'strategy': 'Revive Interest',\n            'actions': ['Brand awareness campaigns', 'Product updates', 'Special promotions'],\n            'message': 'Inactive customers who might be re-engaged.'\n        },\n        'Lost': {\n            'strategy': 'Investigate and Learn',\n            'actions': ['Exit surveys', 'Competitive analysis', 'Process improvement'],\n            'message': 'Lost customers - focus on learning to prevent future churn.'\n        }\n    }\n    \n    return rfm_data, segment_stats, marketing_recommendations\n\n# UI rendering functions\ndef render_dashboard():\n    \"\"\"Render main dashboard with KPIs and charts\"\"\"\n    st.title(\"ðŸ“Š Retail Sales Dashboard\")\n    \n    # Get KPIs\n    kpis = get_kpis()\n    \n    # KPI Cards\n    col1, col2, col3, col4 = st.columns(4)\n    \n    with col1:\n        st.metric(\"ðŸ’° Total Sales\", f\"${kpis['total_sales']:,.2f}\")\n    \n    with col2:\n        st.metric(\"ðŸ“ˆ Monthly Revenue\", f\"${kpis['monthly_revenue']:,.2f}\")\n    \n    with col3:\n        st.metric(\"ðŸ‘¥ Total Customers\", f\"{kpis['total_customers']:,}\")\n    \n    with col4:\n        st.metric(\"ðŸ† Best Product\", kpis['best_product'])\n    \n    st.divider()\n    \n    # Filters\n    st.subheader(\"ðŸ“Š Analytics & Visualizations\")\n    \n    col1, col2, col3 = st.columns(3)\n    \n    with col1:\n        # Date range filter\n        start_date = st.date_input(\"Start Date\", value=date(2024, 1, 1))\n        \n    with col2:\n        end_date = st.date_input(\"End Date\", value=date.today())\n    \n    with col3:\n        # Category filter\n        products_df = get_products()\n        categories = ['All'] + list(products_df['category'].unique())\n        selected_category = st.selectbox(\"Category\", categories)\n    \n    # Get filtered sales data\n    sales_df: pd.DataFrame = get_sales()\n    sales_df['sale_date'] = pd.to_datetime(sales_df['sale_date'])\n    \n    # Apply filters\n    date_mask = (sales_df['sale_date'] >= pd.to_datetime(start_date)) & (sales_df['sale_date'] <= pd.to_datetime(end_date))\n    filtered_sales = cast(pd.DataFrame, sales_df[date_mask].copy())\n    \n    if selected_category != 'All':\n        category_mask = filtered_sales['category'] == selected_category\n        filtered_sales = cast(pd.DataFrame, filtered_sales[category_mask].copy())\n    \n    if len(filtered_sales) > 0:\n        # Charts\n        chart_col1, chart_col2 = st.columns(2)\n        \n        with chart_col1:\n            # Sales trend\n            daily_sales = filtered_sales.groupby('sale_date')['total_amount'].sum().reset_index()\n            fig_trend = px.line(daily_sales, x='sale_date', y='total_amount', \n                              title='ðŸ“ˆ Sales Trend Over Time',\n                              labels={'total_amount': 'Sales Amount ($)', 'sale_date': 'Date'})\n            st.plotly_chart(fig_trend, use_container_width=True)\n        \n        with chart_col2:\n            # Top products\n            top_products = filtered_sales.groupby('product_name')['total_amount'].sum().reset_index()\n            top_products = top_products.sort_values('total_amount', ascending=False).head(10)\n            fig_products = px.bar(top_products, x='total_amount', y='product_name', \n                                orientation='h', title='ðŸ† Top Products by Revenue',\n                                labels={'total_amount': 'Revenue ($)', 'product_name': 'Product'})\n            st.plotly_chart(fig_products, use_container_width=True)\n        \n        chart_col3, chart_col4 = st.columns(2)\n        \n        with chart_col3:\n            # Sales by category\n            category_sales = filtered_sales.groupby('category')['total_amount'].sum().reset_index()\n            fig_category = px.pie(category_sales, values='total_amount', names='category',\n                                title='ðŸ© Sales by Category')\n            st.plotly_chart(fig_category, use_container_width=True)\n        \n        with chart_col4:\n            # Customer demographics\n            customers_df = get_customers()\n            if len(customers_df) > 0:\n                fig_demo = px.histogram(customers_df, x='age', nbins=10, \n                                      title='ðŸ‘¥ Customer Age Distribution',\n                                      labels={'age': 'Age', 'count': 'Number of Customers'})\n                st.plotly_chart(fig_demo, use_container_width=True)\n    else:\n        st.info(\"No sales data available for the selected filters.\")\n\ndef render_manage_data(user_permissions):\n    \"\"\"Render data management interface with role-based access\"\"\"\n    st.title(\"ðŸ“ Manage Data\")\n    \n    # Filter tabs based on permissions\n    available_tabs = []\n    if 'manage_products' in user_permissions:\n        available_tabs.append(\"Products\")\n    if 'manage_customers' in user_permissions:\n        available_tabs.append(\"Customers\")\n    if 'manage_sales' in user_permissions:\n        available_tabs.append(\"Sales\")\n    \n    if not available_tabs:\n        st.error(\"You don't have permission to manage any data\")\n        return\n    \n    # Create tabs based on available permissions\n    if len(available_tabs) == 1:\n        if available_tabs[0] == \"Products\":\n            render_products_management()\n        elif available_tabs[0] == \"Customers\":\n            render_customers_management()\n        elif available_tabs[0] == \"Sales\":\n            render_sales_management()\n    else:\n        tabs = st.tabs(available_tabs)\n        \n        for i, tab_name in enumerate(available_tabs):\n            with tabs[i]:\n                if tab_name == \"Products\":\n                    render_products_management()\n                elif tab_name == \"Customers\":\n                    render_customers_management()\n                elif tab_name == \"Sales\":\n                    render_sales_management()\n\ndef render_products_management():\n    \"\"\"Render products management interface\"\"\"\n    st.subheader(\"ðŸ›ï¸ Products Management\")\n    \n    # Add new product form\n    with st.expander(\"âž• Add New Product\"):\n        with st.form(\"add_product_form\"):\n            col1, col2 = st.columns(2)\n            with col1:\n                name = st.text_input(\"Product Name*\")\n                category = st.text_input(\"Category*\")\n                price = st.number_input(\"Price*\", min_value=0.01, step=0.01)\n            with col2:\n                stock = st.number_input(\"Stock Quantity*\", min_value=0, step=1)\n                description = st.text_area(\"Description\")\n            \n            if st.form_submit_button(\"Add Product\"):\n                if name and category and price > 0:\n                    add_product(name, category, price, stock, description)\n                    st.success(\"Product added successfully!\")\n                    st.rerun()\n                else:\n                    st.error(\"Please fill in all required fields.\")\n    \n    # Products table\n    st.subheader(\"ðŸ“‹ Products List\")\n    products_df = get_products()\n    \n    if len(products_df) > 0:\n        # Low stock threshold\n        low_stock_threshold = st.number_input(\"Low Stock Alert Threshold\", min_value=1, value=10, step=1)\n        \n        # Display products with low stock alerts\n        for index, product in products_df.iterrows():\n            # Highlight low stock\n            if product['stock'] <= low_stock_threshold:\n                st.error(f\"âš ï¸ LOW STOCK ALERT: {product['name']} (Stock: {product['stock']})\")\n            \n            with st.expander(f\"{product['name']} - ${product['price']:.2f} (Stock: {product['stock']})\"):\n                col1, col2, col3 = st.columns([2, 1, 1])\n                \n                with col1:\n                    st.write(f\"**Category:** {product['category']}\")\n                    st.write(f\"**Description:** {product['description']}\")\n                    st.write(f\"**Created:** {product['created_at']}\")\n                \n                with col2:\n                    if st.button(f\"âœï¸ Edit\", key=f\"edit_product_{product['id']}\"):\n                        st.session_state[f'edit_product_{product[\"id\"]}'] = True\n                \n                with col3:\n                    if st.button(f\"ðŸ—‘ï¸ Delete\", key=f\"delete_product_{product['id']}\"):\n                        delete_product(product['id'])\n                        st.success(\"Product deleted!\")\n                        st.rerun()\n                \n                # Edit form\n                if st.session_state.get(f'edit_product_{product[\"id\"]}', False):\n                    with st.form(f\"edit_product_form_{product['id']}\"):\n                        edit_col1, edit_col2 = st.columns(2)\n                        with edit_col1:\n                            edit_name = st.text_input(\"Name\", value=product['name'])\n                            edit_category = st.text_input(\"Category\", value=product['category'])\n                            edit_price = st.number_input(\"Price\", value=float(product['price']), min_value=0.01, step=0.01)\n                        with edit_col2:\n                            edit_stock = st.number_input(\"Stock\", value=int(product['stock']), min_value=0, step=1)\n                            edit_description = st.text_area(\"Description\", value=str(product['description']) if product['description'] is not None else \"\")\n                        \n                        col_save, col_cancel = st.columns(2)\n                        with col_save:\n                            if st.form_submit_button(\"ðŸ’¾ Save\"):\n                                update_product(product['id'], edit_name, edit_category, edit_price, edit_stock, edit_description)\n                                st.session_state[f'edit_product_{product[\"id\"]}'] = False\n                                st.success(\"Product updated!\")\n                                st.rerun()\n                        with col_cancel:\n                            if st.form_submit_button(\"âŒ Cancel\"):\n                                st.session_state[f'edit_product_{product[\"id\"]}'] = False\n                                st.rerun()\n    else:\n        st.info(\"No products found. Add your first product above.\")\n\ndef render_customers_management():\n    \"\"\"Render customers management interface\"\"\"\n    st.subheader(\"ðŸ‘¥ Customers Management\")\n    \n    # Add new customer form\n    with st.expander(\"âž• Add New Customer\"):\n        with st.form(\"add_customer_form\"):\n            col1, col2 = st.columns(2)\n            with col1:\n                name = st.text_input(\"Customer Name*\")\n                email = st.text_input(\"Email*\")\n                phone = st.text_input(\"Phone\")\n            with col2:\n                address = st.text_area(\"Address\")\n                gender = st.selectbox(\"Gender\", [\"Male\", \"Female\", \"Other\"])\n                age = st.number_input(\"Age\", min_value=1, max_value=120, value=30)\n            \n            if st.form_submit_button(\"Add Customer\"):\n                if name and email:\n                    try:\n                        add_customer(name, email, phone, address, gender, age)\n                        st.success(\"Customer added successfully!\")\n                        st.rerun()\n                    except sqlite3.IntegrityError:\n                        st.error(\"Email already exists. Please use a different email.\")\n                else:\n                    st.error(\"Please fill in all required fields.\")\n    \n    # Customers table\n    st.subheader(\"ðŸ“‹ Customers List\")\n    customers_df = get_customers()\n    \n    if len(customers_df) > 0:\n        for index, customer in customers_df.iterrows():\n            with st.expander(f\"{customer['name']} - {customer['email']}\"):\n                col1, col2, col3 = st.columns([2, 1, 1])\n                \n                with col1:\n                    st.write(f\"**Phone:** {customer['phone']}\")\n                    st.write(f\"**Address:** {customer['address']}\")\n                    st.write(f\"**Gender:** {customer['gender']} | **Age:** {customer['age']}\")\n                    st.write(f\"**Created:** {customer['created_at']}\")\n                \n                with col2:\n                    if st.button(f\"âœï¸ Edit\", key=f\"edit_customer_{customer['id']}\"):\n                        st.session_state[f'edit_customer_{customer[\"id\"]}'] = True\n                \n                with col3:\n                    if st.button(f\"ðŸ—‘ï¸ Delete\", key=f\"delete_customer_{customer['id']}\"):\n                        delete_customer(customer['id'])\n                        st.success(\"Customer deleted!\")\n                        st.rerun()\n                \n                # Edit form\n                if st.session_state.get(f'edit_customer_{customer[\"id\"]}', False):\n                    with st.form(f\"edit_customer_form_{customer['id']}\"):\n                        edit_col1, edit_col2 = st.columns(2)\n                        with edit_col1:\n                            edit_name = st.text_input(\"Name\", value=customer['name'])\n                            edit_email = st.text_input(\"Email\", value=customer['email'])\n                            edit_phone = st.text_input(\"Phone\", value=str(customer['phone']) if customer['phone'] is not None else \"\")\n                        with edit_col2:\n                            edit_address = st.text_area(\"Address\", value=str(customer['address']) if customer['address'] is not None else \"\")\n                            gender_options = [\"Male\", \"Female\", \"Other\"]\n                            current_gender = str(customer['gender'])\n                            gender_index = gender_options.index(current_gender) if current_gender in gender_options else 0\n                            edit_gender = st.selectbox(\"Gender\", gender_options, index=gender_index)\n                            edit_age = st.number_input(\"Age\", value=int(customer['age']), min_value=1, max_value=120)\n                        \n                        col_save, col_cancel = st.columns(2)\n                        with col_save:\n                            if st.form_submit_button(\"ðŸ’¾ Save\"):\n                                try:\n                                    update_customer(customer['id'], edit_name, edit_email, edit_phone, edit_address, edit_gender, edit_age)\n                                    st.session_state[f'edit_customer_{customer[\"id\"]}'] = False\n                                    st.success(\"Customer updated!\")\n                                    st.rerun()\n                                except sqlite3.IntegrityError:\n                                    st.error(\"Email already exists. Please use a different email.\")\n                        with col_cancel:\n                            if st.form_submit_button(\"âŒ Cancel\"):\n                                st.session_state[f'edit_customer_{customer[\"id\"]}'] = False\n                                st.rerun()\n    else:\n        st.info(\"No customers found. Add your first customer above.\")\n\ndef render_sales_management():\n    \"\"\"Render sales management interface\"\"\"\n    st.subheader(\"ðŸ’° Sales Management\")\n    \n    # Add new sale form\n    with st.expander(\"âž• Add New Sale\"):\n        with st.form(\"add_sale_form\"):\n            col1, col2 = st.columns(2)\n            \n            products_df = get_products()\n            customers_df = get_customers()\n            \n            if len(products_df) > 0 and len(customers_df) > 0:\n                with col1:\n                    product_options = {f\"{row['name']} (${row['price']:.2f})\": row['id'] for _, row in products_df.iterrows()}\n                    selected_product_display = st.selectbox(\"Select Product*\", list(product_options.keys()))\n                    selected_product_id = product_options[selected_product_display]\n                    \n                    quantity = st.number_input(\"Quantity*\", min_value=1, step=1)\n                \n                with col2:\n                    customer_options = {row['name']: row['id'] for _, row in customers_df.iterrows()}\n                    selected_customer_display = st.selectbox(\"Select Customer*\", list(customer_options.keys()))\n                    selected_customer_id = customer_options[selected_customer_display]\n                    \n                    sale_date = st.date_input(\"Sale Date*\", value=date.today())\n                \n                if st.form_submit_button(\"Add Sale\"):\n                    success, message = add_sale(selected_product_id, selected_customer_id, quantity, sale_date)\n                    if success:\n                        st.success(message)\n                        st.rerun()\n                    else:\n                        st.error(message)\n            else:\n                st.warning(\"Please add products and customers before creating sales.\")\n    \n    # Sales table\n    st.subheader(\"ðŸ“‹ Sales List\")\n    sales_df = get_sales()\n    \n    if len(sales_df) > 0:\n        for index, sale in sales_df.iterrows():\n            with st.expander(f\"Sale #{sale['id']} - {sale['product_name']} - ${sale['total_amount']:.2f}\"):\n                col1, col2 = st.columns([3, 1])\n                \n                with col1:\n                    st.write(f\"**Product:** {sale['product_name']} ({sale['category']})\")\n                    st.write(f\"**Customer:** {sale['customer_name']}\")\n                    st.write(f\"**Quantity:** {sale['quantity']} | **Unit Price:** ${sale['unit_price']:.2f}\")\n                    st.write(f\"**Total Amount:** ${sale['total_amount']:.2f}\")\n                    st.write(f\"**Sale Date:** {sale['sale_date']}\")\n                \n                with col2:\n                    if st.button(f\"ðŸ—‘ï¸ Delete\", key=f\"delete_sale_{sale['id']}\"):\n                        delete_sale(sale['id'])\n                        st.success(\"Sale deleted and stock restored!\")\n                        st.rerun()\n    else:\n        st.info(\"No sales found. Add your first sale above.\")\n\ndef render_reports():\n    \"\"\"Render reports and export functionality\"\"\"\n    st.title(\"ðŸ“Š Reports & Export\")\n    \n    # Filter options\n    col1, col2, col3 = st.columns(3)\n    \n    with col1:\n        start_date = st.date_input(\"Start Date\", value=date(2024, 1, 1))\n    \n    with col2:\n        end_date = st.date_input(\"End Date\", value=date.today())\n    \n    with col3:\n        report_type = st.selectbox(\"Report Type\", [\"Sales Report\", \"Products Report\", \"Customers Report\"])\n    \n    # Generate and display report\n    if report_type == \"Sales Report\":\n        sales_df = get_sales()\n        sales_df['sale_date'] = pd.to_datetime(sales_df['sale_date'])\n        \n        filtered_sales = sales_df[\n            (sales_df['sale_date'] >= pd.to_datetime(start_date)) &\n            (sales_df['sale_date'] <= pd.to_datetime(end_date))\n        ]\n        \n        if len(filtered_sales) > 0:\n            st.subheader(\"ðŸ’° Sales Report Summary\")\n            \n            # Summary metrics\n            col1, col2, col3, col4 = st.columns(4)\n            with col1:\n                st.metric(\"Total Sales\", f\"${filtered_sales['total_amount'].sum():,.2f}\")\n            with col2:\n                st.metric(\"Total Transactions\", len(filtered_sales))\n            with col3:\n                st.metric(\"Average Sale\", f\"${filtered_sales['total_amount'].mean():.2f}\")\n            with col4:\n                st.metric(\"Total Items Sold\", filtered_sales['quantity'].sum())\n            \n            st.subheader(\"ðŸ“‹ Detailed Sales Data\")\n            st.dataframe(filtered_sales, use_container_width=True)\n            \n            # Export button\n            csv_data = filtered_sales.to_csv(index=False)\n            st.download_button(\n                label=\"ðŸ“¥ Download Sales Report (CSV)\",\n                data=csv_data,\n                file_name=f\"sales_report_{start_date}_to_{end_date}.csv\",\n                mime=\"text/csv\"\n            )\n        else:\n            st.info(\"No sales data found for the selected date range.\")\n    \n    elif report_type == \"Products Report\":\n        products_df = get_products()\n        \n        if len(products_df) > 0:\n            st.subheader(\"ðŸ›ï¸ Products Report\")\n            st.dataframe(products_df, use_container_width=True)\n            \n            # Export button\n            csv_data = products_df.to_csv(index=False)\n            st.download_button(\n                label=\"ðŸ“¥ Download Products Report (CSV)\",\n                data=csv_data,\n                file_name=\"products_report.csv\",\n                mime=\"text/csv\"\n            )\n        else:\n            st.info(\"No products found.\")\n    \n    elif report_type == \"Customers Report\":\n        customers_df = get_customers()\n        \n        if len(customers_df) > 0:\n            st.subheader(\"ðŸ‘¥ Customers Report\")\n            st.dataframe(customers_df, use_container_width=True)\n            \n            # Export button\n            csv_data = customers_df.to_csv(index=False)\n            st.download_button(\n                label=\"ðŸ“¥ Download Customers Report (CSV)\",\n                data=csv_data,\n                file_name=\"customers_report.csv\",\n                mime=\"text/csv\"\n            )\n        else:\n            st.info(\"No customers found.\")\n\ndef render_settings(user_permissions):\n    \"\"\"Render settings page with role-based features\"\"\"\n    st.title(\"âš™ï¸ Settings\")\n    \n    current_user = st.session_state.current_user\n    \n    # User profile section\n    st.subheader(\"ðŸ‘¤ User Profile\")\n    with st.expander(\"ðŸ”§ Account Information\", expanded=True):\n        col1, col2 = st.columns(2)\n        with col1:\n            st.write(f\"**Username:** {current_user['username']}\")\n            st.write(f\"**Email:** {current_user['email']}\")\n        with col2:\n            st.write(f\"**Full Name:** {current_user['full_name'] or 'Not set'}\")\n            st.write(f\"**Role:** {current_user['role_name']}\")\n        \n        # Change password form\n        with st.form(\"change_password_form\"):\n            st.markdown(\"**Change Password**\")\n            old_password = st.text_input(\"Current Password\", type=\"password\")\n            new_password = st.text_input(\"New Password\", type=\"password\")\n            confirm_password = st.text_input(\"Confirm New Password\", type=\"password\")\n            \n            if st.form_submit_button(\"ðŸ” Change Password\"):\n                if old_password and new_password and confirm_password:\n                    if new_password == confirm_password:\n                        # Verify current password\n                        user = authenticate_user(current_user['username'], old_password)\n                        if user:\n                            # Update password\n                            conn = get_connection()\n                            cursor = conn.cursor()\n                            new_hash = hash_password(new_password)\n                            cursor.execute('UPDATE users SET password_hash = ? WHERE id = ?', \n                                         (new_hash, current_user['id']))\n                            conn.commit()\n                            conn.close()\n                            st.success(\"Password changed successfully!\")\n                        else:\n                            st.error(\"Current password is incorrect\")\n                    else:\n                        st.error(\"New passwords don't match\")\n                else:\n                    st.error(\"Please fill in all password fields\")\n    \n    st.subheader(\"ðŸ“Š System Information\")\n    \n    # Database information - available to all users\n    with st.expander(\"ðŸ—„ï¸ Database Statistics\"):\n        conn = get_connection()\n        cursor = conn.cursor()\n        \n        # Get table sizes\n        cursor.execute('SELECT COUNT(*) FROM products')\n        products_count = cursor.fetchone()[0]\n        \n        cursor.execute('SELECT COUNT(*) FROM customers')\n        customers_count = cursor.fetchone()[0]\n        \n        cursor.execute('SELECT COUNT(*) FROM sales')\n        sales_count = cursor.fetchone()[0]\n        \n        cursor.execute('SELECT COUNT(*) FROM users')\n        users_count = cursor.fetchone()[0]\n        \n        conn.close()\n        \n        col1, col2, col3, col4 = st.columns(4)\n        with col1:\n            st.metric(\"Products\", products_count)\n        with col2:\n            st.metric(\"Customers\", customers_count)\n        with col3:\n            st.metric(\"Sales\", sales_count)\n        with col4:\n            st.metric(\"Users\", users_count)\n    \n    # System actions based on permissions\n    st.subheader(\"ðŸ”§ System Actions\")\n    \n    col1, col2 = st.columns(2)\n    with col1:\n        if st.button(\"ðŸ”„ Refresh Application\"):\n            st.rerun()\n    \n    with col2:\n        if 'backup_restore' in user_permissions:\n            if st.button(\"ðŸ’¾ Database Backup\"):\n                st.info(\"Database backup functionality will be implemented in future versions\")\n    \n    # Admin-only sections\n    if 'system_settings' in user_permissions:\n        st.subheader(\"ðŸ› ï¸ Administrator Tools\")\n        \n        with st.expander(\"âš ï¸ Advanced System Operations\"):\n            st.warning(\"These operations are for system administrators only and may affect all users.\")\n            \n            col1, col2 = st.columns(2)\n            with col1:\n                if st.button(\"ðŸ”„ Reset Demo Data\", type=\"secondary\"):\n                    st.info(\"Demo data reset functionality coming soon\")\n            \n            with col2:\n                if st.button(\"ðŸ“Š System Maintenance\", type=\"secondary\"):\n                    st.info(\"System maintenance tools coming soon\")\n    \n    # User permissions display\n    with st.expander(\"ðŸ”‘ Your Permissions\"):\n        st.write(\"**Your current permissions:**\")\n        for permission in user_permissions:\n            permission_descriptions = {\n                'view_dashboard': 'ðŸ“Š View Dashboard',\n                'manage_products': 'ðŸ›ï¸ Manage Products',\n                'manage_customers': 'ðŸ‘¥ Manage Customers',\n                'manage_sales': 'ðŸ’° Manage Sales',\n                'view_reports': 'ðŸ“ˆ View Reports',\n                'manage_users': 'ðŸ‘¤ Manage Users',\n                'manage_roles': 'ðŸ·ï¸ Manage Roles',\n                'export_data': 'ðŸ“¤ Export Data',\n                'backup_restore': 'ðŸ’¾ Backup & Restore',\n                'system_settings': 'âš™ï¸ System Settings'\n            }\n            desc = permission_descriptions.get(permission, permission)\n            st.write(f\"â€¢ {desc}\")\n    \n    st.subheader(\"â„¹ï¸ About\")\n    st.info(\"\"\"\n    **Retail Sales Management & Analytics Dashboard**\n    \n    Version: 2.0.0 - with User Role Management\n    \n    This application provides comprehensive retail sales management capabilities including:\n    - Product inventory management\n    - Customer relationship management  \n    - Sales tracking and analytics\n    - Advanced sales forecasting with ML\n    - Customer segmentation analysis\n    - Interactive dashboards and reports\n    - Role-based access control\n    - User management system\n    - Data export functionality\n    \n    Built with Streamlit, SQLite, Pandas, Plotly, and scikit-learn.\n    \"\"\")\n\ndef render_forecasting():\n    \"\"\"Render sales forecasting interface\"\"\"\n    st.title(\"ðŸ”® Sales Forecasting & Analytics\")\n    \n    # Forecasting controls\n    col1, col2, col3 = st.columns(3)\n    \n    with col1:\n        forecast_days = st.selectbox(\"Forecast Period\", [7, 14, 30, 60, 90], index=2)\n    \n    with col2:\n        model_type = st.selectbox(\"Model Type\", ['linear', 'polynomial'])\n    \n    with col3:\n        confidence_level = st.selectbox(\"Confidence Level\", [80, 90, 95], index=1)\n    \n    st.divider()\n    \n    # Generate forecast\n    with st.spinner(\"Generating forecast...\"):\n        historical_data, forecast_data, model_stats = generate_sales_forecast(forecast_days, model_type, confidence_level)\n    \n    if historical_data is not None and forecast_data is not None and model_stats is not None:\n        # Display model performance\n        col1, col2, col3 = st.columns(3)\n        \n        with col1:\n            st.metric(\"Model Accuracy (RÂ²)\", f\"{model_stats['r2']:.3f}\")\n        \n        with col2:\n            st.metric(\"Mean Error\", f\"${model_stats['mae']:.2f}\")\n        \n        with col3:\n            total_forecast = forecast_data['predicted_sales'].sum()\n            st.metric(\"Total Forecast Revenue\", f\"${total_forecast:,.2f}\")\n        \n        # Forecast chart\n        st.subheader(\"ðŸ“ˆ Sales Forecast Visualization\")\n        \n        # Combine historical and forecast data for plotting\n        fig = go.Figure()\n        \n        # Historical data\n        fig.add_trace(go.Scatter(\n            x=historical_data['sale_date'],\n            y=historical_data['total_amount'],\n            mode='lines+markers',\n            name='Historical Sales',\n            line=dict(color='#1f77b4'),\n            marker=dict(size=4)\n        ))\n        \n        # Confidence interval upper bound\n        fig.add_trace(go.Scatter(\n            x=forecast_data['date'],\n            y=forecast_data['upper_bound'],\n            mode='lines',\n            name=f'{confidence_level}% Confidence Upper',\n            line=dict(color='rgba(255,127,14,0.3)', dash='dot'),\n            showlegend=False\n        ))\n        \n        # Confidence interval lower bound\n        fig.add_trace(go.Scatter(\n            x=forecast_data['date'],\n            y=forecast_data['lower_bound'],\n            mode='lines',\n            name=f'{confidence_level}% Confidence Lower',\n            line=dict(color='rgba(255,127,14,0.3)', dash='dot'),\n            fill='tonexty',\n            fillcolor='rgba(255,127,14,0.2)',\n            showlegend=False\n        ))\n        \n        # Forecast data (main prediction)\n        fig.add_trace(go.Scatter(\n            x=forecast_data['date'],\n            y=forecast_data['predicted_sales'],\n            mode='lines+markers',\n            name=f'Forecast ({confidence_level}% Confidence)',\n            line=dict(color='#ff7f0e', dash='dash'),\n            marker=dict(size=4)\n        ))\n        \n        fig.update_layout(\n            title=f\"{forecast_days}-Day Sales Forecast ({model_type.title()} Model)\",\n            xaxis_title=\"Date\",\n            yaxis_title=\"Sales Amount ($)\",\n            hovermode='x unified',\n            showlegend=True\n        )\n        \n        st.plotly_chart(fig, use_container_width=True)\n        \n        # Forecast summary table\n        st.subheader(\"ðŸ“Š Detailed Forecast Data\")\n        \n        # Show first 10 days of forecast\n        display_forecast = forecast_data.head(10).copy()\n        display_forecast['date'] = display_forecast['date'].dt.strftime('%Y-%m-%d')\n        display_forecast['predicted_sales'] = display_forecast['predicted_sales'].round(2)\n        \n        st.dataframe(display_forecast, use_container_width=True)\n        \n        # Weekly/Monthly summaries\n        col1, col2 = st.columns(2)\n        \n        with col1:\n            st.subheader(\"ðŸ“… Weekly Forecast Summary\")\n            forecast_data['week'] = forecast_data['date'].dt.isocalendar().week\n            weekly_forecast = forecast_data.groupby('week')['predicted_sales'].sum().reset_index()\n            weekly_forecast['predicted_sales'] = weekly_forecast['predicted_sales'].round(2)\n            st.dataframe(weekly_forecast, use_container_width=True)\n        \n        with col2:\n            st.subheader(\"ðŸ“… Monthly Forecast Summary\")\n            forecast_data['month'] = forecast_data['date'].dt.strftime('%Y-%m')\n            monthly_forecast = forecast_data.groupby('month')['predicted_sales'].sum().reset_index()\n            monthly_forecast['predicted_sales'] = monthly_forecast['predicted_sales'].round(2)\n            st.dataframe(monthly_forecast, use_container_width=True)\n        \n        # Export forecast data\n        st.subheader(\"ðŸ“¥ Export Forecast\")\n        if st.button(\"ðŸ“Š Download Forecast Data (CSV)\"):\n            csv_data = forecast_data.to_csv(index=False)\n            st.download_button(\n                label=\"Download CSV\",\n                data=csv_data,\n                file_name=f\"sales_forecast_{forecast_days}days_{datetime.now().strftime('%Y%m%d')}.csv\",\n                mime=\"text/csv\"\n            )\n    else:\n        st.warning(\"âš ï¸ Insufficient historical data for forecasting. Please ensure you have at least 7 days of sales data.\")\n        st.info(\"ðŸ’¡ Add more sales records in the 'Manage Data' section to enable forecasting.\")\n    \n    st.divider()\n    \n    # Product velocity analysis\n    st.subheader(\"ðŸš€ Product Sales Velocity Analysis\")\n    st.markdown(\"*Analyze product performance and predict inventory needs*\")\n    \n    velocity_data, recommendations = get_product_sales_velocity()\n    \n    if len(velocity_data) > 0:\n        # Display velocity metrics\n        col1, col2, col3 = st.columns(3)\n        \n        with col1:\n            velocity_df = cast(pd.DataFrame, velocity_data)\n            avg_velocity = velocity_df['avg_daily_quantity'].mean()\n            st.metric(\"Avg Daily Sales Velocity\", f\"{avg_velocity:.1f} units/day\")\n        \n        with col2:\n            fast_movers = len(velocity_df[velocity_df['avg_daily_quantity'] > avg_velocity])\n            st.metric(\"Fast-Moving Products\", f\"{fast_movers}\")\n        \n        with col3:\n            low_stock_products = len(velocity_df[velocity_df['days_until_stockout'] < 14])\n            st.metric(\"Low Stock Alert\", f\"{low_stock_products} products\")\n        \n        # Velocity chart\n        fig_velocity = px.scatter(\n            velocity_df, \n            x='avg_daily_quantity', \n            y='avg_daily_revenue',\n            size='stock',\n            color='days_until_stockout',\n            hover_data=['product_name', 'transaction_count'],\n            title='Product Sales Velocity Matrix',\n            labels={\n                'avg_daily_quantity': 'Daily Quantity Sold',\n                'avg_daily_revenue': 'Daily Revenue ($)',\n                'days_until_stockout': 'Days Until Stockout',\n                'stock': 'Current Stock'\n            },\n            color_continuous_scale='RdYlGn_r'\n        )\n        \n        st.plotly_chart(fig_velocity, use_container_width=True)\n        \n        # Velocity table\n        st.subheader(\"ðŸ“‹ Product Velocity Details\")\n        \n        # Format the data for display\n        display_velocity = velocity_df[[\n            'product_name', 'avg_daily_quantity', 'avg_daily_revenue', \n            'stock', 'days_until_stockout', 'transaction_count'\n        ]].copy()\n        \n        display_velocity['avg_daily_quantity'] = display_velocity['avg_daily_quantity'].round(2)\n        display_velocity['avg_daily_revenue'] = display_velocity['avg_daily_revenue'].round(2)\n        # Convert infinite values to 'No Sales' string  \n        for idx in display_velocity.index:\n            if display_velocity.loc[idx, 'days_until_stockout'] == float('inf'):\n                display_velocity.loc[idx, 'days_until_stockout'] = 'No Sales'\n        \n        # Color code based on urgency\n        def color_stockout_days(val):\n            if val == 'No Sales':\n                return 'background-color: #f0f0f0'\n            elif isinstance(val, (int, float)) and val < 7:\n                return 'background-color: #ffcccb'\n            elif isinstance(val, (int, float)) and val < 14:\n                return 'background-color: #fff3cd'\n            else:\n                return 'background-color: #d4edda'\n        \n        styled_velocity = display_velocity.style.applymap(\n            color_stockout_days, subset=['days_until_stockout']\n        )\n        \n        st.dataframe(styled_velocity, use_container_width=True)\n        \n        # Recommendations\n        st.subheader(\"ðŸ’¡ Automated Reorder Recommendations\")\n        \n        if recommendations:\n            urgent_recs = [r for r in recommendations if r['type'] == 'urgent']\n            warning_recs = [r for r in recommendations if r['type'] == 'warning']\n            slow_recs = [r for r in recommendations if r['type'] == 'slow_mover']\n            \n            if urgent_recs:\n                st.error(f\"ðŸš¨ **URGENT REORDERS** ({len(urgent_recs)} products)\")\n                for rec in urgent_recs:\n                    with st.expander(f\"ðŸ”´ {rec['product_name']} - {rec['days_until_stockout']:.1f} days left\"):\n                        col1, col2 = st.columns(2)\n                        with col1:\n                            st.write(f\"**Current Stock:** {rec['current_stock']} units\")\n                            st.write(f\"**Daily Sales:** {rec['avg_daily_sales']:.2f} units/day\")\n                        with col2:\n                            st.write(f\"**Recommended Order:** {rec['recommended_order']} units\")\n                            st.write(f\"**Priority:** HIGH\")\n            \n            if warning_recs:\n                st.warning(f\"âš ï¸ **WARNING REORDERS** ({len(warning_recs)} products)\")\n                for rec in warning_recs:\n                    with st.expander(f\"ðŸŸ¡ {rec['product_name']} - {rec['days_until_stockout']:.1f} days left\"):\n                        col1, col2 = st.columns(2)\n                        with col1:\n                            st.write(f\"**Current Stock:** {rec['current_stock']} units\")\n                            st.write(f\"**Daily Sales:** {rec['avg_daily_sales']:.2f} units/day\")\n                        with col2:\n                            st.write(f\"**Recommended Order:** {rec['recommended_order']} units\")\n                            st.write(f\"**Priority:** MEDIUM\")\n            \n            if slow_recs:\n                with st.expander(f\"ðŸ“Š **SLOW MOVERS** ({len(slow_recs)} products)\"):\n                    for rec in slow_recs:\n                        st.info(f\"â€¢ {rec['product_name']}: {rec['current_stock']} units in stock, no recent sales\")\n            \n            if not urgent_recs and not warning_recs:\n                st.success(\"âœ… All products have adequate stock levels based on current sales velocity.\")\n        else:\n            st.info(\"ðŸ“Š No specific recommendations available. All products appear to have adequate stock levels.\")\n    \n    else:\n        st.info(\"ðŸ“Š No recent sales data available for velocity analysis. Add sales records to see insights.\")\n\ndef render_customer_segmentation():\n    \"\"\"Render customer segmentation analysis interface\"\"\"\n    st.title(\"ðŸ‘¥ Customer Segmentation & Marketing Analytics\")\n    st.markdown(\"*Analyze customer behavior patterns using RFM analysis and generate targeted marketing strategies*\")\n    \n    # Calculate RFM metrics\n    with st.spinner(\"Calculating RFM metrics...\"):\n        rfm_data = calculate_rfm_metrics()\n    \n    if len(rfm_data) == 0:\n        st.warning(\"âš ï¸ Insufficient data for customer segmentation analysis.\")\n        st.info(\"ðŸ’¡ Add customers and sales records in the 'Manage Data' section to enable segmentation analysis.\")\n        return\n    \n    # Perform customer segmentation\n    rfm_data, segment_stats, marketing_recommendations = segment_customers(rfm_data)\n    \n    # Show information about dataset size for small datasets\n    num_customers = len(rfm_data)\n    if num_customers < 5:\n        st.info(f\"â„¹ï¸ **Small Dataset Notice**: You have {num_customers} customers. RFM analysis is optimized for larger datasets (5+ customers) but still provides meaningful insights for your current customer base.\")\n    elif num_customers < 10:\n        st.info(f\"â„¹ï¸ **Growing Dataset**: You have {num_customers} customers. Consider adding more customer data to unlock more detailed segmentation insights.\")\n    \n    # Overview metrics\n    st.subheader(\"ðŸ“Š Customer Portfolio Overview\")\n    \n    col1, col2, col3, col4 = st.columns(4)\n    \n    with col1:\n        total_customers = len(rfm_data)\n        st.metric(\"Total Customers\", f\"{total_customers:,}\")\n    \n    with col2:\n        avg_monetary = rfm_data['monetary'].mean()\n        st.metric(\"Avg Customer Value\", f\"${avg_monetary:,.2f}\")\n    \n    with col3:\n        top_segment = segment_stats.loc[segment_stats['total_revenue'].idxmax(), 'segment']\n        st.metric(\"Top Revenue Segment\", top_segment)\n    \n    with col4:\n        total_revenue = rfm_data['monetary'].sum()\n        st.metric(\"Total Revenue\", f\"${total_revenue:,.2f}\")\n    \n    st.divider()\n    \n    # RFM Distribution Analysis\n    st.subheader(\"ðŸŽ¯ RFM Score Distribution\")\n    \n    tab1, tab2 = st.tabs([\"ðŸ“ˆ RFM Metrics\", \"ðŸŽ¯ Segment Analysis\"])\n    \n    with tab1:\n        # RFM distribution charts\n        col1, col2, col3 = st.columns(3)\n        \n        with col1:\n            fig_recency = px.histogram(\n                rfm_data, \n                x='recency', \n                title='ðŸ“… Recency Distribution (Days Since Last Purchase)',\n                labels={'recency': 'Days Since Last Purchase', 'count': 'Number of Customers'},\n                nbins=20\n            )\n            st.plotly_chart(fig_recency, use_container_width=True)\n        \n        with col2:\n            fig_frequency = px.histogram(\n                rfm_data, \n                x='frequency', \n                title='ðŸ”„ Frequency Distribution (Number of Purchases)',\n                labels={'frequency': 'Number of Purchases', 'count': 'Number of Customers'},\n                nbins=10\n            )\n            st.plotly_chart(fig_frequency, use_container_width=True)\n        \n        with col3:\n            fig_monetary = px.histogram(\n                rfm_data, \n                x='monetary', \n                title='ðŸ’° Monetary Distribution (Total Spending)',\n                labels={'monetary': 'Total Spending ($)', 'count': 'Number of Customers'},\n                nbins=20\n            )\n            st.plotly_chart(fig_monetary, use_container_width=True)\n        \n        # 3D RFM scatter plot\n        st.subheader(\"ðŸ“Š 3D RFM Analysis\")\n        fig_3d = px.scatter_3d(\n            rfm_data,\n            x='recency',\n            y='frequency', \n            z='monetary',\n            color='segment',\n            hover_data=['name', 'rfm_score'],\n            title='Customer RFM 3D Analysis',\n            labels={\n                'recency': 'Recency (Days)',\n                'frequency': 'Frequency (Purchases)',\n                'monetary': 'Monetary ($)'\n            }\n        )\n        st.plotly_chart(fig_3d, use_container_width=True)\n    \n    with tab2:\n        # Customer segment analysis\n        st.subheader(\"ðŸ“‹ Customer Segment Breakdown\")\n        \n        # Segment overview chart\n        fig_segments = px.pie(\n            segment_stats,\n            values='count',\n            names='segment',\n            title='Customer Distribution by Segment',\n            hover_data=['percentage']\n        )\n        st.plotly_chart(fig_segments, use_container_width=True)\n        \n        # Segment statistics table\n        st.subheader(\"ðŸ“Š Segment Statistics\")\n        \n        # Format the segment stats for display\n        display_stats = segment_stats.copy()\n        display_stats['avg_monetary'] = display_stats['avg_monetary'].apply(lambda x: f\"${x:,.2f}\")\n        display_stats['total_revenue'] = display_stats['total_revenue'].apply(lambda x: f\"${x:,.2f}\")\n        display_stats['avg_recency'] = display_stats['avg_recency'].apply(lambda x: f\"{x:.1f} days\")\n        display_stats['avg_frequency'] = display_stats['avg_frequency'].apply(lambda x: f\"{x:.1f} purchases\")\n        display_stats['percentage'] = display_stats['percentage'].apply(lambda x: f\"{x}%\")\n        \n        st.dataframe(display_stats, use_container_width=True)\n    \n    st.divider()\n    \n    # Marketing Recommendations\n    st.subheader(\"ðŸŽ¯ Marketing Strategy Recommendations\")\n    st.markdown(\"*Actionable strategies for each customer segment*\")\n    \n    # Create tabs for each segment with customers\n    active_segments = segment_stats['segment'].tolist()\n    \n    if active_segments:\n        # Group segments by priority\n        high_priority = ['Champions', 'Loyal Customers', 'Cannot Lose Them', 'At Risk']\n        medium_priority = ['Potential Loyalists', 'Need Attention', 'Promising']\n        low_priority = ['New Customers', 'About to Sleep', 'Hibernating', 'Lost']\n        \n        priority_tabs = st.tabs([\"ðŸ”´ High Priority\", \"ðŸŸ¡ Medium Priority\", \"ðŸŸ¢ Low Priority\"])\n        \n        with priority_tabs[0]:\n            render_segment_recommendations(active_segments, high_priority, marketing_recommendations, rfm_data)\n        \n        with priority_tabs[1]:\n            render_segment_recommendations(active_segments, medium_priority, marketing_recommendations, rfm_data)\n        \n        with priority_tabs[2]:\n            render_segment_recommendations(active_segments, low_priority, marketing_recommendations, rfm_data)\n    \n    st.divider()\n    \n    # Customer Details\n    st.subheader(\"ðŸ‘¤ Individual Customer Analysis\")\n    \n    # Customer selection\n    customer_options = rfm_data['name'].tolist()\n    selected_customer = st.selectbox(\"Select Customer for Detailed Analysis\", customer_options)\n    \n    if selected_customer:\n        customer_data = rfm_data[rfm_data['name'] == selected_customer].iloc[0]\n        \n        col1, col2 = st.columns(2)\n        \n        with col1:\n            st.write(f\"**Customer:** {customer_data['name']}\")\n            st.write(f\"**Email:** {customer_data['email']}\")\n            st.write(f\"**Segment:** {customer_data['segment']}\")\n            st.write(f\"**RFM Score:** {customer_data['rfm_score']}\")\n        \n        with col2:\n            st.write(f\"**Recency:** {customer_data['recency']} days\")\n            st.write(f\"**Frequency:** {customer_data['frequency']} purchases\")\n            st.write(f\"**Monetary:** ${customer_data['monetary']:,.2f}\")\n            st.write(f\"**Age:** {customer_data['age']} years\")\n        \n        # Display segment-specific recommendations\n        segment = customer_data['segment']\n        if segment in marketing_recommendations:\n            rec = marketing_recommendations[segment]\n            st.info(f\"**Strategy:** {rec['strategy']}\")\n            st.write(f\"**Message:** {rec['message']}\")\n            st.write(f\"**Recommended Actions:** {', '.join(rec['actions'])}\")\n    \n    st.divider()\n    \n    # Export functionality\n    st.subheader(\"ðŸ“¥ Export Customer Segmentation Data\")\n    \n    col1, col2 = st.columns(2)\n    \n    with col1:\n        if st.button(\"ðŸ“Š Download Customer Segments (CSV)\"):\n            csv_data = rfm_data.to_csv(index=False)\n            st.download_button(\n                label=\"Download CSV\",\n                data=csv_data,\n                file_name=f\"customer_segments_{datetime.now().strftime('%Y%m%d')}.csv\",\n                mime=\"text/csv\"\n            )\n    \n    with col2:\n        if st.button(\"ðŸ“ˆ Download Segment Statistics (CSV)\"):\n            csv_data = segment_stats.to_csv(index=False)\n            st.download_button(\n                label=\"Download Statistics CSV\",\n                data=csv_data,\n                file_name=f\"segment_statistics_{datetime.now().strftime('%Y%m%d')}.csv\",\n                mime=\"text/csv\"\n            )\n\ndef render_segment_recommendations(active_segments, priority_segments, marketing_recommendations, rfm_data):\n    \"\"\"Render marketing recommendations for segments by priority\"\"\"\n    priority_active = [seg for seg in priority_segments if seg in active_segments]\n    \n    if not priority_active:\n        st.info(\"No customers in this priority category.\")\n        return\n    \n    for segment in priority_active:\n        if segment in marketing_recommendations:\n            rec = marketing_recommendations[segment]\n            customer_count = len(rfm_data[rfm_data['segment'] == segment])\n            \n            with st.expander(f\"ðŸ“‹ {segment} ({customer_count} customers)\"):\n                col1, col2 = st.columns(2)\n                \n                with col1:\n                    st.write(f\"**Strategy:** {rec['strategy']}\")\n                    st.write(f\"**Message:** {rec['message']}\")\n                \n                with col2:\n                    st.write(\"**Recommended Actions:**\")\n                    for action in rec['actions']:\n                        st.write(f\"â€¢ {action}\")\n                \n                # Show top customers in this segment\n                segment_customers = rfm_data[rfm_data['segment'] == segment].nlargest(3, 'monetary')\n                if len(segment_customers) > 0:\n                    st.write(\"**Top Customers in Segment:**\")\n                    for _, customer in segment_customers.iterrows():\n                        st.write(f\"â€¢ {customer['name']} - ${customer['monetary']:,.2f} (RFM: {customer['rfm_score']})\")\n\ndef render_user_management():\n    \"\"\"Render user management interface\"\"\"\n    st.title(\"ðŸ‘¤ User Management\")\n    st.markdown(\"Manage user accounts, roles, and permissions\")\n    \n    tab1, tab2, tab3 = st.tabs([\"ðŸ‘¥ Users\", \"ðŸ·ï¸ Roles\", \"âž• Add User\"])\n    \n    with tab1:\n        st.subheader(\"ðŸ‘¥ User Accounts\")\n        \n        users_df = get_all_users()\n        if len(users_df) > 0:\n            # Display users in a more user-friendly format\n            for _, user in users_df.iterrows():\n                with st.container():\n                    col1, col2, col3, col4 = st.columns([3, 2, 2, 2])\n                    \n                    with col1:\n                        status_icon = \"ðŸŸ¢\" if user['is_active'] else \"ðŸ”´\"\n                        st.write(f\"{status_icon} **{user['full_name'] or user['username']}**\")\n                        st.caption(f\"@{user['username']} â€¢ {user['email']}\")\n                    \n                    with col2:\n                        st.write(f\"ðŸ·ï¸ {user['role_name']}\")\n                    \n                    with col3:\n                        last_login = user['last_login']\n                        if last_login:\n                            login_date = pd.to_datetime(last_login).strftime('%Y-%m-%d')\n                            st.write(f\"ðŸ•’ {login_date}\")\n                        else:\n                            st.write(\"ðŸ•’ Never\")\n                    \n                    with col4:\n                        # Don't allow editing yourself or other super admins\n                        current_user = st.session_state.current_user\n                        can_edit = (user['id'] != current_user['id'] and \n                                  user['role_name'] != 'Super Admin')\n                        \n                        if can_edit:\n                            if st.button(f\"âœï¸ Edit\", key=f\"edit_user_{user['id']}\"):\n                                st.session_state[f\"editing_user_{user['id']}\"] = True\n                        else:\n                            st.write(\"ðŸ”’ Protected\")\n                    \n                    # Edit form\n                    if st.session_state.get(f\"editing_user_{user['id']}\", False):\n                        with st.form(f\"edit_user_form_{user['id']}\"):\n                            st.markdown(f\"**Editing: {user['username']}**\")\n                            \n                            roles_df = get_all_roles()\n                            role_options = {row['name']: row['id'] for _, row in roles_df.iterrows()}\n                            \n                            new_username = st.text_input(\"Username\", value=user['username'])\n                            new_email = st.text_input(\"Email\", value=user['email'])\n                            new_full_name = st.text_input(\"Full Name\", value=user['full_name'] or \"\")\n                            new_role = st.selectbox(\"Role\", options=list(role_options.keys()), \n                                                  index=list(role_options.values()).index(user['role_name'] if user['role_name'] in role_options.values() else 1))\n                            new_is_active = st.checkbox(\"Active\", value=user['is_active'])\n                            \n                            col1, col2, col3 = st.columns(3)\n                            with col1:\n                                if st.form_submit_button(\"ðŸ’¾ Save\"):\n                                    success, message = update_user(\n                                        user['id'], new_username, new_email, \n                                        role_options[new_role], new_full_name, new_is_active,\n                                        current_user['id']\n                                    )\n                                    if success:\n                                        st.success(message)\n                                        st.session_state[f\"editing_user_{user['id']}\"] = False\n                                        st.rerun()\n                                    else:\n                                        st.error(message)\n                            \n                            with col2:\n                                if st.form_submit_button(\"âŒ Cancel\"):\n                                    st.session_state[f\"editing_user_{user['id']}\"] = False\n                                    st.rerun()\n                            \n                            with col3:\n                                if st.form_submit_button(\"ðŸ—‘ï¸ Delete\", type=\"secondary\"):\n                                    success, message = delete_user(user['id'], current_user['id'])\n                                    if success:\n                                        st.success(message)\n                                        st.session_state[f\"editing_user_{user['id']}\"] = False\n                                        st.rerun()\n                                    else:\n                                        st.error(message)\n                    \n                    st.markdown(\"---\")\n        else:\n            st.info(\"No users found\")\n    \n    with tab2:\n        st.subheader(\"ðŸ·ï¸ User Roles\")\n        \n        roles_df = get_all_roles()\n        \n        for _, role in roles_df.iterrows():\n            with st.expander(f\"ðŸ·ï¸ {role['name']}\"):\n                st.write(f\"**Description:** {role['description']}\")\n                \n                # Get permissions for this role\n                conn = get_connection()\n                permissions_query = '''\n                    SELECT p.name, p.description\n                    FROM permissions p\n                    JOIN role_permissions rp ON p.id = rp.permission_id\n                    WHERE rp.role_id = ?\n                    ORDER BY p.name\n                '''\n                role_permissions = pd.read_sql_query(permissions_query, conn, params=(role['id'],))\n                conn.close()\n                \n                if len(role_permissions) > 0:\n                    st.write(\"**Permissions:**\")\n                    for _, perm in role_permissions.iterrows():\n                        st.write(f\"â€¢ **{perm['name']}**: {perm['description']}\")\n                else:\n                    st.write(\"No permissions assigned\")\n    \n    with tab3:\n        st.subheader(\"âž• Add New User\")\n        \n        with st.form(\"add_user_form\"):\n            roles_df = get_all_roles()\n            role_options = {row['name']: row['id'] for _, row in roles_df.iterrows()}\n            \n            username = st.text_input(\"Username *\")\n            email = st.text_input(\"Email *\")\n            password = st.text_input(\"Password *\", type=\"password\")\n            full_name = st.text_input(\"Full Name\")\n            role = st.selectbox(\"Role *\", options=list(role_options.keys()))\n            \n            if st.form_submit_button(\"ðŸ‘¤ Create User\"):\n                if username and email and password and role:\n                    current_user = st.session_state.current_user\n                    success, message = create_user(username, email, password, role_options[role], full_name, current_user['id'])\n                    if success:\n                        st.success(message)\n                        st.rerun()\n                    else:\n                        st.error(message)\n                else:\n                    st.error(\"Please fill in all required fields\")\n\n# Main application\ndef main():\n    \"\"\"Main application function\"\"\"\n    \n    # Initialize database\n    init_db()\n    \n    # Check authentication\n    is_authenticated = check_authentication()\n    \n    if not is_authenticated:\n        # Show login form if not authenticated\n        st.title(\"ðŸ›ï¸ Retail Sales Management & Analytics\")\n        st.markdown(\"---\")\n        login_form()\n        return\n    \n    # User is authenticated, show main application\n    user = st.session_state.current_user\n    \n    # Initialize session state\n    if 'current_page' not in st.session_state:\n        st.session_state.current_page = 'Dashboard'\n    \n    # Sidebar navigation\n    st.sidebar.title(\"ðŸ›ï¸ Retail Sales Manager\")\n    st.sidebar.markdown(f\"ðŸ‘¤ Welcome, **{user['full_name'] or user['username']}**\")\n    st.sidebar.markdown(f\"ðŸ·ï¸ Role: **{user['role_name']}**\")\n    st.sidebar.markdown(\"---\")\n    \n    # Build navigation based on user permissions\n    user_permissions = get_user_permissions(user['id'])\n    \n    pages = {}\n    \n    # Dashboard - available to all authenticated users\n    if 'view_dashboard' in user_permissions:\n        pages[\"ðŸ“Š Dashboard\"] = \"Dashboard\"\n    \n    # Forecasting - available to users with view_reports permission\n    if 'view_reports' in user_permissions:\n        pages[\"ðŸ”® Forecasting\"] = \"Forecasting\"\n        pages[\"ðŸ‘¥ Customer Segments\"] = \"Segmentation\"\n        pages[\"ðŸ“Š Reports & Export\"] = \"Reports\"\n    \n    # Data management - requires specific permissions\n    if any(perm in user_permissions for perm in ['manage_products', 'manage_customers', 'manage_sales']):\n        pages[\"ðŸ“ Manage Data\"] = \"Manage Data\"\n    \n    # User management - Super Admin and Manager only\n    if 'manage_users' in user_permissions:\n        pages[\"ðŸ‘¤ User Management\"] = \"User Management\"\n    \n    # Settings - available to all\n    pages[\"âš™ï¸ Settings\"] = \"Settings\"\n    \n    # Navigation buttons\n    for page_display, page_key in pages.items():\n        if st.sidebar.button(page_display, use_container_width=True):\n            st.session_state.current_page = page_key\n    \n    st.sidebar.markdown(\"---\")\n    \n    # Logout button\n    if st.sidebar.button(\"ðŸšª Logout\", use_container_width=True):\n        if 'session_token' in st.session_state:\n            logout_user(st.session_state.session_token)\n        if 'session_token' in st.session_state:\n            del st.session_state.session_token\n        if 'current_user' in st.session_state:\n            del st.session_state.current_user\n        st.rerun()\n    \n    st.sidebar.markdown(\"---\")\n    st.sidebar.markdown(\"ðŸ’¡ **Quick Stats**\")\n    \n    # Quick stats in sidebar\n    try:\n        kpis = get_kpis()\n        st.sidebar.metric(\"ðŸ’° Total Sales\", f\"${kpis['total_sales']:,.0f}\")\n        st.sidebar.metric(\"ðŸ‘¥ Customers\", f\"{kpis['total_customers']:,}\")\n    except:\n        st.sidebar.info(\"Loading stats...\")\n    \n    # Render selected page with permission checks\n    current_page = st.session_state.current_page\n    \n    if current_page == \"Dashboard\":\n        if 'view_dashboard' in user_permissions:\n            render_dashboard()\n        else:\n            st.error(\"You don't have permission to access the Dashboard\")\n    elif current_page == \"Forecasting\":\n        if 'view_reports' in user_permissions:\n            render_forecasting()\n        else:\n            st.error(\"You don't have permission to access Forecasting\")\n    elif current_page == \"Segmentation\":\n        if 'view_reports' in user_permissions:\n            render_customer_segmentation()\n        else:\n            st.error(\"You don't have permission to access Customer Segmentation\")\n    elif current_page == \"Manage Data\":\n        if any(perm in user_permissions for perm in ['manage_products', 'manage_customers', 'manage_sales']):\n            render_manage_data(user_permissions)\n        else:\n            st.error(\"You don't have permission to manage data\")\n    elif current_page == \"Reports\":\n        if 'view_reports' in user_permissions:\n            render_reports()\n        else:\n            st.error(\"You don't have permission to access Reports\")\n    elif current_page == \"User Management\":\n        if 'manage_users' in user_permissions:\n            render_user_management()\n        else:\n            st.error(\"You don't have permission to manage users\")\n    elif current_page == \"Settings\":\n        render_settings(user_permissions)\n\nif __name__ == \"__main__\":\n    main()\n","size_bytes":105810},"pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"numpy>=2.3.3\",\n    \"pandas>=2.3.2\",\n    \"plotly>=6.3.0\",\n    \"scikit-learn>=1.7.2\",\n    \"scipy>=1.16.2\",\n    \"streamlit>=1.50.0\",\n]\n","size_bytes":279}},"version":1}